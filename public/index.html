<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MetalMetric — Gold-to-Silver Ratio (GSR)</title>
  <meta name="description" content="MetalMetric: Gold-to-Silver Ratio dashboard with historical charts, metrics, and alerts." />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="/styles.css" />

  <!-- Prevent flash: apply saved/system theme ASAP -->
  <script>
    (function () {
      try {
        const KEY = "mm_theme";
        const saved = localStorage.getItem(KEY);
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const theme = (saved === "dark" || saved === "light") ? saved : (prefersDark ? "dark" : "light");
        document.documentElement.setAttribute("data-theme", theme);
      } catch (e) {}
    })();
  </script>

  <style>
    /* Ensures Chart.js canvases have a stable height within your existing layout */
    .chartCanvasWrap { height: 260px; position: relative; }
    canvas.chartCanvas { width: 100% !important; height: 100% !important; display: block; }

    /* Pricing section anchor spacing (kept local to avoid global impact) */
    #pricing { scroll-margin-top: 18px; }

    /* =========================================================
       KPI GRID: 4-UP (index only)
       - Keeps KPI cards evenly spaced when adding Platinum
       - Responsive collapse: 4 -> 2 -> 1
       ========================================================= */
    .kpiGrid.kpiGrid--4{
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 1100px){
      .kpiGrid.kpiGrid--4{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 620px){
      .kpiGrid.kpiGrid--4{ grid-template-columns: 1fr; }
    }

    /* =========================================================
       Ticker speed override for THIS page only (slower)
       Your styles.css also defines defaults; this safely overrides speed.
       ========================================================= */
    :root{
      --tickerSeconds: 64s; /* adjust slower/faster here */
    }
    @media (max-width: 720px){
      :root{ --tickerSeconds: 78s; }
    }
  </style>
</head>

<body>
  <!-- =========================================================
       FIXED FULL-WIDTH TOP TICKER (ABOVE EVERYTHING)
       (Styling is handled in /styles.css to avoid conflicts)
       ========================================================= -->
  <div class="ticker" role="region" aria-label="Live prices ticker">
    <div class="tickerInner">
      <div class="tickerViewport">
        <div class="tickerTrack" id="tickerTrack">
          <div class="tickerGroup" id="tickerLiveGroup">
            <span class="tickItem">
              <span class="tickLabel">GSR</span>
              <span class="tickValue" id="sbGsr">—</span>
            </span>
            <span class="tickSep">•</span>
            <span class="tickItem">
              <span class="tickLabel">Δ</span>
              <span class="tickValue" id="sbDelta">—</span>
            </span>
            <span class="tickSep">•</span>
            <span class="tickItem">
              <span class="tickLabel">UPDATED</span>
              <span class="tickValue" id="sbUpdated">—</span>
            </span>
            <span class="tickSep">•</span>
            <span class="tickItem">
              <span class="tickLabel">GOLD</span>
              <span class="tickValue" id="sbGold">—</span>
            </span>
            <span class="tickSep">•</span>
            <span class="tickItem">
              <span class="tickLabel">SILVER</span>
              <span class="tickValue" id="sbSilver">—</span>
            </span>
            <span class="tickSep">•</span>
            <span class="tickItem tickCta">
              <span class="tickLabel">SIGNALS</span>
              <span class="tickValue"><a href="/pro">PRO</a> / <a href="/elite">ELITE</a></span>
            </span>
            <span class="tickSep">•</span>
          </div>
          <!-- clones appended by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       NEW NAV BANNER (clean, stable in light/dark)
       ========================================================= -->
  <div class="navBannerSticky" role="navigation" aria-label="Primary navigation">
    <div class="navBannerSurface">
      <div class="navBanner shell">
        <div class="navTabs" id="navTabs">
          <a class="navTab" href="#pricing">Pricing</a>
          <a class="navTab navTab--pro" href="/pro">Pro</a>
          <a class="navTab navTab--elite" href="/elite">Elite</a>
          <a class="navTab" href="/melt">Melt Calculator</a>

          <button id="themeToggle" class="navTab" type="button" aria-pressed="false" title="Switch theme">
            <span class="ttIcon ttIconMoon" aria-hidden="true" style="display:none;">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M21 14.4A8.5 8.5 0 0 1 9.6 3a7 7 0 1 0 11.4 11.4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <span class="ttIcon ttIconSun" aria-hidden="true" style="display:none;">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" stroke="currentColor" stroke-width="2"/>
                <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            <span class="ttLabel">—</span>
          </button>

          <button id="refreshBtn" class="navTab" type="button">Refresh</button>
        </div>
      </div>
    </div>
  </div>

  <main class="shell">
    <header class="topbar">
      <div class="titleBlock">
        <div class="brandLockup">
          <img
  class="brandMark"
  src="/metalmetric-mark.svg"
  alt="MetalMetric"
  width="36"
  height="36"
/>
          <div class="brandStack">
            <div class="brandRow">
              <h1 class="brandName">MetalMetric</h1>
              <span class="brandBadge">Premium Signals</span>
            </div>
            <p class="sub brandSub">Gold-to-Silver Ratio dashboard — Alerts when it matters. Not when it moves.</p>
            <p class="metaLine brandMeta">
              <span class="muted">Last updated:</span> <span id="lastUpdatedHuman">—</span>
              <span class="dot">•</span>
              <span class="muted">UTC date:</span> <span id="utcDate">—</span>
            </p>
          </div>
        </div>
      </div>
      <!-- actions removed intentionally (now in nav banner) -->
    </header>

    <!-- ===========================
         SPOT (Spot price /api/spot)
         =========================== -->
    <section class="kpiGrid kpiGrid--4" aria-label="Spot prices">
      <div class="kpiCard">
        <div class="kpiLabel">GSR (SPOT)</div>
        <div class="kpiValue" id="gsr">—</div>
        <div class="kpiSub">
          <span class="muted">Δ vs prev:</span>
          <span id="deltaAbs">—</span>
          <span class="muted"> (</span><span id="deltaPct">—</span><span class="muted">)</span>
        </div>
      </div>
      <div class="kpiCard kpiCard--coinGold">
        <div class="kpiLabel">GOLD (SPOT USD)</div>
        <div class="kpiValue" id="gold">—</div>
        <div class="kpiSub"><span class="muted">Fetched at:</span> <span id="fetchedAt">—</span></div>
      </div>
      <div class="kpiCard kpiCard--coinSilver">
        <div class="kpiLabel">SILVER (SPOT USD)</div>
        <div class="kpiValue" id="silver">—</div>
        <div class="kpiSub"><span class="muted">Source:</span> <span id="source">—</span></div>
      </div>
      <div class="kpiCard kpiCard--coinPlatinum">
        <div class="kpiLabel">PLATINUM (SPOT USD)</div>
        <div class="kpiValue" id="platinum">—</div>
        <div class="kpiSub"><span class="muted">Source:</span> <span id="platinumSource">—</span></div>
      </div>
    </section>

    <!-- ======================================
         FUTURES-DERIVED (Futures /api/futures)
         ====================================== -->
    <section class="kpiGrid kpiGrid--4" aria-label="Futures-derived prices">
      <div class="kpiCard">
        <div class="kpiLabel">GSR (FUTURES)</div>
        <div class="kpiValue" id="futGsr">—</div>
        <div class="kpiSub"><span class="muted">Market time:</span> <span id="futMarketTime">—</span></div>
      </div>
      <div class="kpiCard kpiCard--coinGold kpiCard--futures">
        <div class="kpiLabel">GOLD (FUTURES USD)</div>
        <div class="kpiValue" id="futGold">—</div>
        <div class="kpiSub"><span class="muted">Fetched at:</span> <span id="futFetchedAt">—</span></div>
      </div>
      <div class="kpiCard kpiCard--coinSilver kpiCard--futures">
        <div class="kpiLabel">SILVER (FUTURES USD)</div>
        <div class="kpiValue" id="futSilver">—</div>
        <div class="kpiSub"><span class="muted">Source:</span> <span id="futSource">—</span></div>
      </div>
      <div class="kpiCard kpiCard--coinPlatinum kpiCard--futures">
        <div class="kpiLabel">PLATINUM (FUTURES USD)</div>
        <div class="kpiValue" id="futPlatinum">—</div>
        <div class="kpiSub"><span class="muted">Source:</span> <span id="futPlatinumSource">—</span></div>
      </div>
    </section>

    <section class="controls">
      <div class="segmented" role="tablist" aria-label="Range">
        <button class="segBtn isActive" data-range="1M">1M</button>
        <button class="segBtn" data-range="3M">3M</button>
        <button class="segBtn" data-range="6M">6M</button>
        <button class="segBtn" data-range="1Y">1Y</button>
        <button class="segBtn" data-range="MAX">MAX</button>
      </div>
      <div class="toggles">
        <label class="toggle"><input type="checkbox" id="showGold" checked> <span>Gold</span></label>
        <label class="toggle"><input type="checkbox" id="showSilver" checked> <span>Silver</span></label>
        <label class="toggle"><input type="checkbox" id="showGsr" checked> <span>GSR</span></label>
      </div>
    </section>

   <section class="card" id="chartsCard">
  <div class="cardHead cardHead--charts">
    <div class="cardTitle">Charts</div>
    <div class="cardMeta" id="rangeLabel">—</div>

    <!-- Premium controls (safe: app.js checks for existence) -->
    <div class="chartTools">
      <button id="chartsResetZoomBtn" class="iconBtn" type="button" title="Reset zoom" aria-label="Reset zoom">⟲</button>
      <button id="chartsExpandBtn" class="iconBtn" type="button" title="Expand charts" aria-label="Expand charts">⤢</button>
      <button id="chartsCloseBtn" class="iconBtn hidden" type="button" title="Close" aria-label="Close charts">✕</button>
    </div>
  </div>

  <!-- Optional lock/teaser overlay (only shows if your JS enables it) -->
  <div id="chartsLockOverlay" class="chartsLockOverlay hidden" aria-hidden="true">
    <div class="lockTitle">Interactive charts are Pro+</div>
    <div class="lockSub">Zoom, pan, synced crosshair, and insights.</div>
    <div class="lockActions">
      <a class="lockBtn" href="#pricing">Upgrade</a>
      <button id="lockDismissBtn" class="lockBtn lockBtn--ghost" type="button">Not now</button>
    </div>
  </div>

  <!-- Clicked-point details popover (JS fills this) -->
  <div id="pointDetails" class="pointDetails hidden" role="status" aria-live="polite"></div>

  <div id="emptyState" class="emptyState hidden">
    <div class="emptyTitle">No history yet</div>
    <div class="emptySub">Your database has only one data point. Run backfill (or let cron run daily).</div>
  </div>

  <div id="chartsWrap" class="chartsWrap">
    <div class="chartBlock" id="chartGsr">
      <div class="chartHeader">
        <div class="chartName">GSR</div>
        <div class="chartHint muted">ratio</div>
      </div>
      <div class="chartCanvasWrap">
        <canvas id="chartGsrCanvas" class="chartCanvas"></canvas>
      </div>
    </div>

    <div class="chartBlock" id="chartGold">
      <div class="chartHeader">
        <div class="chartName">Gold Spot (USD)</div>
        <div class="chartHint muted">close</div>
      </div>
      <div class="chartCanvasWrap">
        <canvas id="chartGoldCanvas" class="chartCanvas"></canvas>
      </div>
    </div>

    <div class="chartBlock" id="chartSilver">
      <div class="chartHeader">
        <div class="chartName">Silver Spot (USD)</div>
        <div class="chartHint muted">close</div>
      </div>
      <div class="chartCanvasWrap">
        <canvas id="chartSilverCanvas" class="chartCanvas"></canvas>
      </div>
    </div>
  </div>

  <details class="details">
    <summary>Show history table</summary>
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Date (UTC)</th>
            <th>GSR</th>
            <th>Gold</th>
            <th>Silver</th>
          </tr>
        </thead>
        <tbody id="historyTable"></tbody>
      </table>
    </div>
  </details>
</section>


    <section class="card" id="pricing" aria-label="Pricing">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Pricing</div>
          <div class="cardMeta">Upgrade for signals, alerts, and premium tools</div>
        </div>
      </div>
      <div class="pricingHeroSimple">
        <div class="pricingEyebrow">SUBSCRIPTIONS • COMING NEXT</div>
        <h2 class="pricingHeadline">Plans that grow with you</h2>
        <p class="pricingLead">
          Free gives you the live ratio + history. Pro and Elite add signals, alerts, and research tools built to reduce noise and speed up decisions.
        </p>
      </div>
      <div class="pricingGrid3" role="list">
        <article class="priceCard priceCard--free" role="listitem" aria-label="Free plan">
          <div class="priceTop">
            <div class="priceIcon" aria-hidden="true"></div>
            <div class="pricePlan">Free</div>
            <div class="priceTagline">Clean dashboard for tracking GSR.</div>
          </div>
          <div class="priceAmountRow">
            <div class="priceAmount">$0</div>
            <div class="pricePer">/mo</div>
          </div>
          <a class="priceBtn priceBtn--ghost" href="/">Use MetalMetric for free</a>
          <ul class="priceList">
            <li>Live refresh + stored DB history</li>
            <li>Charts + range selection</li>
            <li>History table</li>
          </ul>
          <div class="priceFootnote">No signup required.</div>
        </article>

        <article class="priceCard priceCard--pro" role="listitem" aria-label="Pro plan">
          <div class="priceTop">
            <div class="priceIcon priceIcon--pro" aria-hidden="true"></div>
            <div class="pricePlan">Pro</div>
            <div class="priceTagline">Signals + tools that make metals actionable.</div>
          </div>
          <div class="priceAmountRow">
            <div class="priceAmount">$9</div>
            <div class="pricePer">/mo</div>
          </div>
          <a class="priceBtn priceBtn--dark" href="/pro">Get Pro plan</a>
          <ul class="priceList">
            <li>Buy/Sell Score + 10 smart alerts</li>
            <li>Smart Melt Value Calculator (jewelry/coins)</li>
            <li>Hidden Assets Vault + inflation category alerts</li>
          </ul>
          <div class="priceFootnote">Best for consistent weekly decision-making.</div>
        </article>

        <article class="priceCard priceCard--elite" role="listitem" aria-label="Elite plan">
          <div class="priceTop">
            <div class="priceIcon priceIcon--elite" aria-hidden="true"></div>
            <div class="pricePlan">Elite</div>
            <div class="priceTagline">System tools + workflows for power users.</div>
          </div>
          <div class="priceAmountRow">
            <div class="priceAmount">$19</div>
            <div class="pricePer">/mo</div>
          </div>
          <a class="priceBtn priceBtn--dark" href="/elite">Get Elite plan</a>
          <ul class="priceList">
            <li>50 alerts + percentiles + confidence scoring</li>
            <li>Scenario + ladder + CSV export (research suite)</li>
            <li>Inflation-proof envelopes + hedge-linked goals + jewelry scanner</li>
          </ul>
          <div class="priceFootnote">Built for serious allocation + timing.</div>
        </article>
      </div>
      <div class="pricingLegal muted">
        *Usage limits apply. Prices shown don’t include applicable tax.
      </div>
    </section>

    <footer class="footer">
      <span class="muted">Tip:</span> If numbers don’t update after a deploy, hard refresh and clear the service worker cache.
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.2.0/dist/chartjs-plugin-zoom.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.1.0/chartjs-plugin-annotation.min.js"></script>

  <!-- Chart theme helper (keeps axis/legend readable in dark mode) -->
  <script>
    (function(){
      function isDark(){
        return (document.documentElement.getAttribute("data-theme") || "light").toLowerCase() === "dark";
      }

      function applyChartTheme(){
        if (!window.Chart || !Chart.getChart) return false;

        const dark = isDark();
        const tick = dark ? "rgba(255,255,255,.78)" : "rgba(17,17,20,.72)";
        const grid = dark ? "rgba(255,255,255,.08)" : "rgba(17,17,20,.10)";
        const title = dark ? "rgba(255,255,255,.88)" : "rgba(17,17,20,.86)";

        // defaults
        Chart.defaults.color = tick;
        Chart.defaults.borderColor = grid;

        const ids = ["chartGsrCanvas","chartGoldCanvas","chartSilverCanvas"];
        let found = 0;

        ids.forEach(id => {
          const c = document.getElementById(id);
          if (!c) return;
          const chart = Chart.getChart(c);
          if (!chart) return;
          found++;

          // scales
          if (chart.options && chart.options.scales){
            Object.values(chart.options.scales).forEach(sc => {
              sc.ticks = sc.ticks || {};
              sc.grid = sc.grid || {};
              sc.border = sc.border || {};
              sc.ticks.color = tick;
              sc.grid.color = grid;
              sc.border.color = grid;
              sc.title = sc.title || {};
              sc.title.color = title;
            });
          }

          // legend / tooltip
          chart.options.plugins = chart.options.plugins || {};
          chart.options.plugins.legend = chart.options.plugins.legend || {};
          chart.options.plugins.legend.labels = chart.options.plugins.legend.labels || {};
          chart.options.plugins.legend.labels.color = tick;

          chart.options.plugins.tooltip = chart.options.plugins.tooltip || {};
          chart.options.plugins.tooltip.titleColor = dark ? "rgba(255,255,255,.92)" : "rgba(17,17,20,.92)";
          chart.options.plugins.tooltip.bodyColor  = dark ? "rgba(255,255,255,.86)" : "rgba(17,17,20,.86)";
          chart.options.plugins.tooltip.backgroundColor = dark ? "rgba(0,0,0,.78)" : "rgba(255,255,255,.92)";
          chart.options.plugins.tooltip.borderColor = dark ? "rgba(255,255,255,.12)" : "rgba(17,17,20,.10)";
          chart.options.plugins.tooltip.borderWidth = 1;

          // Force immediate repaint
          chart.update("none");
          try { if (chart.draw) chart.draw(); } catch(e) {}
        });

        return found > 0;
      }

      // NEW: schedule a couple quick re-applies so ticks repaint immediately after theme flips
      function scheduleApply(){
        try { applyChartTheme(); } catch(e) {}
        try { requestAnimationFrame(() => { try { applyChartTheme(); } catch(e) {} }); } catch(e) {}
        setTimeout(() => { try { applyChartTheme(); } catch(e) {} }, 120);
        setTimeout(() => { try { applyChartTheme(); } catch(e) {} }, 350);
      }

      // Run after everything is loaded (app.js builds charts after fetch)
      window.addEventListener("load", () => {
        let tries = 0;
        const t = setInterval(() => {
          tries++;
          const ok = applyChartTheme();
          if (ok || tries > 20) clearInterval(t);
        }, 250);
      });

      // NEW: auto-apply whenever data-theme changes (no refresh button needed)
      try{
        const mo = new MutationObserver((muts) => {
          for (const m of muts){
            if (m.type === "attributes" && m.attributeName === "data-theme"){
              scheduleApply();
              break;
            }
          }
        });
        mo.observe(document.documentElement, { attributes: true, attributeFilter: ["data-theme"] });
      }catch(e){}

      // Expose so theme toggle can call it immediately
      window.mmApplyChartTheme = scheduleApply;
    })();
  </script>

  <script defer src="/app.js"></script>

  <!-- =========================================================
       THEME TOGGLE (single button, moon/sun, persistent)
       FIXED: shows ACTION label (Dark in light, Light in dark)
       ========================================================= -->
  <script>
    (function(){
      const KEY = "mm_theme";
      const root = document.documentElement;
      const btn = document.getElementById("themeToggle");
      const label = btn ? btn.querySelector(".ttLabel") : null;
      const moon = btn ? btn.querySelector(".ttIconMoon") : null;
      const sun  = btn ? btn.querySelector(".ttIconSun")  : null;

      const getTheme = () => {
        const t = (root.getAttribute("data-theme") || "").toLowerCase();
        return (t === "dark" || t === "light") ? t : "light";
      };

      const apply = (theme) => {
        root.setAttribute("data-theme", theme);
        const isDark = theme === "dark";

        // aria-pressed reflects current state
        if (btn) btn.setAttribute("aria-pressed", isDark ? "true" : "false");

        // Show ACTION label/icons:
        // If currently dark => show "Light" (sun) to switch to light
        // If currently light => show "Dark" (moon) to switch to dark
        if (label) label.textContent = isDark ? "Light" : "Dark";
        if (moon) moon.style.display = isDark ? "none" : "inline-flex";
        if (sun)  sun.style.display  = isDark ? "inline-flex" : "none";
        if (btn) btn.title = isDark ? "Switch to Light" : "Switch to Dark";

        try { localStorage.setItem(KEY, theme); } catch(e) {}

        // Update Chart.js colors (if charts already exist)
        try {
          if (window.mmApplyChartTheme) window.mmApplyChartTheme();
        } catch(e) {}
      };

      apply(getTheme());

      if (btn){
        btn.addEventListener("click", () => {
          const next = (getTheme() === "dark") ? "light" : "dark";
          apply(next);

          // run again shortly in case charts update after toggle
          setTimeout(() => { try { window.mmApplyChartTheme && window.mmApplyChartTheme(); } catch(e) {} }, 250);
        });
      }
    })();
  </script>

  <!-- =========================================================
       FUTURES-DERIVED KPI UPDATER (Home page only)
       ========================================================= -->
  <script>
    (function(){
      const $ = (id) => document.getElementById(id);

      const toNum = (v) => {
        const n = (typeof v === "number") ? v : (v == null ? NaN : Number(v));
        return Number.isFinite(n) ? n : NaN;
      };

      const money = (v) => {
        const n = toNum(v);
        if (!Number.isFinite(n)) return "—";
        return n.toLocaleString(undefined, {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      };

      const fmtGsr = (v) => {
        const n = toNum(v);
        return Number.isFinite(n) ? n.toFixed(2) : "—";
      };

      const fmtIsoUtc = (iso) => {
        if (!iso) return "—";
        try{
          const d = new Date(iso);
          if (isNaN(d.getTime())) return String(iso);
          return d.toISOString().replace("T"," ").replace("Z"," UTC");
        }catch{
          return String(iso);
        }
      };

      async function fetchJsonNoStore(path){
        const url = path + (path.includes("?") ? "&" : "?") + "ts=" + Date.now();
        const res = await fetch(url, { cache: "no-store", headers: { "Accept": "application/json" } });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { throw new Error(`Non-JSON from ${path}`); }
        if (!res.ok || data?.ok === false) throw new Error(data?.error ? String(data.error) : `HTTP ${res.status}`);
        return data;
      }

      function setText(id, val){
        const el = $(id);
        if (el) el.textContent = val;
      }

      async function refreshFutures(){
        const data = await fetchJsonNoStore("/api/futures?symbols=GC=F,SI=F,PL=F");

        setText("futGold", money(data.gold_usd));
        setText("futSilver", money(data.silver_usd));
        setText("futPlatinum", money(data.platinum_usd));
        setText("futGsr", fmtGsr(data.gsr));

        setText("futFetchedAt", fmtIsoUtc(data.fetched_at_utc));
        setText("futSource", data.source ? String(data.source) : "—");
        setText("futPlatinumSource", data.source ? String(data.source) : "—");

        const mDate = data?.market?.date ? String(data.market.date) : "";
        const mTime = data?.market?.time ? String(data.market.time) : "";
        setText("futMarketTime", (mDate || mTime) ? `${mDate} ${mTime}`.trim() : "—");
      }

      async function refreshFuturesSafe(){
        try { await refreshFutures(); }
        catch(e){ console.warn("[index] futures refresh failed:", e); }
      }

      window.addEventListener("load", refreshFuturesSafe);

      const btn = $("refreshBtn");
      if (btn) btn.addEventListener("click", refreshFuturesSafe);

      setInterval(refreshFuturesSafe, 60000);
    })();
  </script>

 <!-- =========================================================
     SPOT PLATINUM KPI UPDATER (Home page only)
     Replaced: platinum pulls from /api/platinum_live (free, no MetalPriceAPI quota)
     ========================================================= -->
<script>
  (function(){
    const $ = (id) => document.getElementById(id);

    const toNum = (v) => {
      const n = (typeof v === "number") ? v : (v == null ? NaN : Number(v));
      return Number.isFinite(n) ? n : NaN;
    };

    const money = (v) => {
      const n = toNum(v);
      if (!Number.isFinite(n)) return "—";
      return n.toLocaleString(undefined, {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    };

    async function fetchJsonNoStore(path){
      const url = path + (path.includes("?") ? "&" : "?") + "ts=" + Date.now();
      const res = await fetch(url, { cache: "no-store", headers: { "Accept": "application/json" } });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { throw new Error(`Non-JSON from ${path}`); }
      if (!res.ok || data?.ok === false) throw new Error(data?.error ? String(data.error) : `HTTP ${res.status}`);
      return data;
    }

    function setText(id, val){
      const el = $(id);
      if (el) el.textContent = val;
    }

    async function refreshSpotPlatinum(){
      // New: platinum comes from its own endpoint, avoiding MetalPriceAPI quota issues
      const data = await fetchJsonNoStore("/api/platinum_live");

      // Accept multiple possible keys just in case
      const pt = (data && (data.platinum_usd ?? data.platinum ?? data.xpt_usd)) ?? null;

      setText("platinum", money(pt));
      setText("platinumSource", data?.source ? String(data.source) : "—");
    }

    async function refreshSpotPlatinumSafe(){
      try { await refreshSpotPlatinum(); }
      catch(e){ console.warn("[index] spot platinum refresh failed:", e); }
    }

    window.addEventListener("load", refreshSpotPlatinumSafe);

    const btn = $("refreshBtn");
    if (btn) btn.addEventListener("click", refreshSpotPlatinumSafe);
  })();
</script>

  <!-- =========================================================
       Ticker sync + auto-duplicate (prevents blanks)
       ========================================================= -->
  <script>
    (function(){
      const $ = (id) => document.getElementById(id);
      const readText = (id) => {
        const el = $(id);
        const t = (el && el.textContent || "").trim();
        return t && t !== "—" ? t : "—";
      };
      const setText = (id, val) => {
        const el = $(id);
        if (el) el.textContent = val;
      };
      const computeDeltaLine = () => {
        const abs = readText("deltaAbs");
        const pct = readText("deltaPct");
        if (abs === "—" && pct === "—") return "—";
        if (abs !== "—" && pct !== "—") return `${abs} (${pct})`;
        return abs !== "—" ? abs : pct;
      };
      const stripCloneIds = (node) => {
        node.querySelectorAll("[id]").forEach(el => el.removeAttribute("id"));
      };
      const ensureTickerFilled = () => {
        const track = $("tickerTrack");
        const live = $("tickerLiveGroup");
        if (!track || !live) return;
        track.classList.remove("isReady");
        track.querySelectorAll(".tickerClone").forEach(n => n.remove());
        const viewport = track.closest(".tickerViewport");
        if (!viewport) return;
        const target = viewport.clientWidth * 3;
        let guard = 0;
        const makeClone = () => {
          const c = live.cloneNode(true);
          c.classList.add("tickerClone");
          c.setAttribute("aria-hidden","true");
          c.removeAttribute("id");
          stripCloneIds(c);
          return c;
        };
        while (track.scrollWidth < target && guard < 50) {
          track.appendChild(makeClone());
          guard++;
        }
        requestAnimationFrame(() => requestAnimationFrame(() => {
          track.classList.add("isReady");
        }));
      };
      const sync = () => {
        setText("sbGold", readText("gold"));
        setText("sbSilver", readText("silver"));
        setText("sbGsr", readText("gsr"));
        setText("sbDelta", computeDeltaLine());
        setText("sbUpdated", readText("lastUpdatedHuman"));
      };
      sync();
      ensureTickerFilled();
      window.addEventListener("load", () => {
        sync();
        ensureTickerFilled();
      });
      const mo = new MutationObserver(() => {
        sync();
        ensureTickerFilled();
      });
      ["gold","silver","gsr","deltaAbs","deltaPct","lastUpdatedHuman"].forEach(id => {
        const el = $(id);
        if (el) mo.observe(el, { childList: true, characterData: true, subtree: true });
      });
      window.addEventListener("resize", ensureTickerFilled);
      setInterval(sync, 1200);
    })();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
