<!-- DROP-IN PART 1/2: vault/index.html  (everything ABOVE the <script> tag) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vault Tracker — MetalMetric</title>

  <link rel="stylesheet" href="../styles.css" />
  <link rel="icon" href="../icon.svg" />

  <style>
    :root{
      --m-bg: #0b0f14;
      --m-panel: rgba(255,255,255,.04);
      --m-panel2: rgba(255,255,255,.06);
      --m-border: rgba(255,255,255,.10);
      --m-border2: rgba(255,255,255,.14);
      --m-text: rgba(255,255,255,.92);
      --m-subtext: rgba(255,255,255,.64);
      --m-muted: rgba(255,255,255,.50);
      --m-shadow: 0 18px 60px rgba(0,0,0,.50);
      --m-radius: 18px;
      --m-radius2: 14px;

      --m-accent: rgba(142, 200, 255, 1);
      --m-gold: rgba(245, 200, 90, 1);
      --m-silver: rgba(210, 220, 232, 1);
      --m-plat: rgba(180, 195, 255, 1);

      --m-good: rgba(52, 211, 153, 1);
      --m-bad: rgba(248, 113, 113, 1);
      --m-warn: rgba(251, 191, 36, 1);

      /* “vault cabinet” palette */
      --v-steelA: rgba(255,255,255,.07);
      --v-steelB: rgba(255,255,255,.03);
      --v-steelEdge: rgba(255,255,255,.12);
      --v-ledge: rgba(0,0,0,.32);
      --v-woodA: rgba(82, 62, 38, .28);
      --v-woodB: rgba(30, 24, 18, .24);
    }

    body.vaultPage{
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(142,200,255,.12), transparent 60%),
        radial-gradient(900px 520px at 80% 0%, rgba(245,200,90,.10), transparent 60%),
        var(--m-bg);
      color: var(--m-text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      overflow-x: hidden;
    }

    body.vaultPage a{ color: inherit; text-decoration: none; }
    body.vaultPage a:hover{ text-decoration: underline; text-decoration-color: rgba(255,255,255,.35); }

    .mono{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }

    .meltWrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    .meltTop{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 18px;
    }
    .meltBrand{
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 220px;
    }
    .meltMark{
      width: 34px; height: 34px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.04));
      border: 1px solid var(--m-border);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      display: grid; place-items: center;
    }
    .meltMark svg{ opacity: .92; }
    .meltBrandText{ display: flex; flex-direction: column; line-height: 1.1; }
    .meltBrandText b{ font-size: 14px; letter-spacing: .2px; }
    .meltBrandText span{ font-size: 12px; color: var(--m-subtext); }

    .meltNav{
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pillRow{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--m-border);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      color: rgba(255,255,255,.86);
      font-size: 12px;
      white-space: nowrap;
      user-select: none;
    }
    .pill strong{ font-weight: 650; letter-spacing: .2px; }
    .pill small{ color: var(--m-subtext); font-size: 11px; }
    .pill.isActive{
      background: rgba(142,200,255,.08);
      border-color: rgba(142,200,255,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.25), 0 0 0 4px rgba(142,200,255,.08);
    }

    .btn{
      appearance: none;
      border: 1px solid var(--m-border);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      padding: 9px 11px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.28);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select: none;
    }
    .btn:hover{ background: rgba(255,255,255,.09); border-color: var(--m-border2); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 4px rgba(142,200,255,.18), 0 18px 60px rgba(0,0,0,.35);
      border-color: rgba(142,200,255,.45);
    }
    .btnPrimary{
      border-color: rgba(142,200,255,.35);
      background: rgba(142,200,255,.12);
    }
    .btnPrimary:hover{
      background: rgba(142,200,255,.18);
      border-color: rgba(142,200,255,.48);
    }
    .btnDanger{
      border-color: rgba(248,113,113,.30);
      background: rgba(248,113,113,.10);
    }
    .btnDanger:hover{
      background: rgba(248,113,113,.14);
      border-color: rgba(248,113,113,.45);
    }
    .btn:disabled{
      opacity: .55;
      cursor: not-allowed;
      transform: none !important;
    }

    .meltHero{
      margin: 12px 0 22px;
      padding: 18px 18px 0;
    }
    .meltHero h1{
      margin: 0 0 6px;
      font-size: 28px;
      letter-spacing: -0.02em;
    }
    .meltHero p{
      margin: 0;
      color: var(--m-subtext);
      font-size: 14px;
      line-height: 1.45;
    }

    .meltGrid{
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 980px){
      .meltGrid{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--m-radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--m-border);
      box-shadow: var(--m-shadow);
      overflow: hidden;
      min-width: 0;
    }
    .cardHeader{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .cardHeader h2{
      margin: 0;
      font-size: 13px;
      letter-spacing: .3px;
      font-weight: 650;
      color: rgba(255,255,255,.86);
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .cardBody{ padding: 16px; }

    .row{
      display: grid;
      grid-template-columns: 1fr 160px;
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .row{ grid-template-columns: 1fr 160px; }
    }
    @media (max-width: 560px){
      .row{ grid-template-columns: 1fr; }
    }
    .field label{
      display: block;
      font-size: 11px;
      color: var(--m-subtext);
      margin-bottom: 6px;
      letter-spacing: .2px;
    }
    .control{
      width: 100%;
      border-radius: 12px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.90);
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
      transition: border-color .12s ease, box-shadow .12s ease, background .12s ease;
      box-sizing: border-box;
    }
    .control:hover{ border-color: rgba(255,255,255,.16); }
    .control:focus{
      border-color: rgba(142,200,255,.50);
      box-shadow: 0 0 0 4px rgba(142,200,255,.14);
      background: rgba(255,255,255,.06);
    }
    select.control{ padding-right: 34px; }
    textarea.control{ min-height: 84px; resize: vertical; }

    .resultHero{
      padding: 18px 16px 12px;
      background: linear-gradient(180deg, rgba(142,200,255,.10), rgba(255,255,255,.00));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .resultHero .label{
      font-size: 11px;
      color: rgba(255,255,255,.65);
      letter-spacing: .28em;
      text-transform: uppercase;
    }
    .resultHero .value{
      margin-top: 8px;
      font-size: 44px;
      font-weight: 760;
      letter-spacing: -0.03em;
      line-height: 1.0;
    }
    .resultHero .sub{
      margin-top: 8px;
      color: var(--m-subtext);
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      min-height: 18px;
    }
    .deltaUp{ color: rgba(52,211,153,.95); }
    .deltaDown{ color: rgba(248,113,113,.95); }
    .deltaFlat{ color: rgba(255,255,255,.62); }

    .kpiRow{
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      padding: 14px 16px 16px;
    }
    @media (max-width: 980px){
      .kpiRow{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .kpi{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px 12px;
      min-width: 0;
    }
    .kpi .k{ font-size: 10px; color: rgba(255,255,255,.58); letter-spacing: .22em; text-transform: uppercase; }
    .kpi .v{ margin-top: 6px; font-size: 16px; font-weight: 720; letter-spacing: -0.01em; }
    .kpi .s{ margin-top: 2px; font-size: 11px; color: rgba(255,255,255,.62); }

    .pulse { animation: mmPulse 650ms ease; }
    @keyframes mmPulse {
      0% { box-shadow: none; }
      35% { box-shadow: 0 0 0 4px rgba(142,200,255,.16), 0 18px 60px rgba(0,0,0,.35); }
      100% { box-shadow: none; }
    }

    .status{
      font-size: 12px;
      color: var(--m-subtext);
      min-height: 18px;
      margin-top: 10px;
    }
    .status.bad{ color: rgba(248,113,113,.95); }
    .status.good{ color: rgba(52,211,153,.95); }
    .status.warn{ color: rgba(251,191,36,.95); }

    .actionRow{
      margin-top: 12px;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
      width: 100%;
    }

    .locked{ position: relative; filter: blur(0); }
    .locked[data-locked="true"]{ filter: blur(0.2px); }
    .lockOverlay{
      display: none;
      position: absolute;
      inset: 0;
      border-radius: 14px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      align-items: center;
      justify-content: center;
      padding: 12px;
      text-align: center;
      color: rgba(255,255,255,.88);
      font-size: 13px;
    }
    .locked[data-locked="true"] .lockOverlay{ display: flex; }

    /* =========================================================
       VAULT RACKS: luxury cabinet + collector shelves (1–4)
       ========================================================= */
    .vaultRacksWrap{ margin-top: 14px; }

    .vaultRacksHead{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin: 6px 0 10px;
    }
    .vaultRacksHead .title{
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,.70);
    }
    .vaultRacksHead .hint{
      font-size: 12px;
      color: rgba(255,255,255,.55);
    }

    /* Filter drawer */
    .vaultToolsRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin: 10px 0 12px;
      flex-wrap: wrap;
    }
    .drawer{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.22);
    }
    .drawerHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .drawerHead b{
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,.74);
    }
    .drawerBody{
      padding: 12px;
      display:none;
    }
    .drawer.isOpen .drawerBody{ display:block; }
    .drawerGrid{
      display:grid;
      grid-template-columns: 1.3fr 1fr 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 980px){
      .drawerGrid{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 560px){
      .drawerGrid{ grid-template-columns: 1fr; }
    }
    .miniHint{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255,255,255,.55);
    }
    .chipTiny{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: rgba(255,255,255,.72);
      white-space: nowrap;
    }

    .vaultCabinet{
      position: relative;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(1200px 520px at 30% 0%, rgba(142,200,255,.06), transparent 60%),
        radial-gradient(900px 520px at 70% 0%, rgba(245,200,90,.05), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: 0 24px 80px rgba(0,0,0,.52);
      overflow: hidden;
    }
    .vaultCabinet::before{
      content:"";
      position:absolute; inset: 0;
      background:
        linear-gradient(90deg, rgba(255,255,255,.05), transparent 20%, transparent 80%, rgba(255,255,255,.05)),
        radial-gradient(900px 420px at 50% -20%, rgba(255,255,255,.06), transparent 65%);
      pointer-events:none;
      opacity:.9;
    }
    .vaultCabinet::after{
      content:"";
      position:absolute; inset:0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.18;
      pointer-events:none;
    }

    .vaultCabinetFrame{
      position:absolute; inset: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,.35),
        inset 0 20px 60px rgba(0,0,0,.30);
      pointer-events:none;
      z-index: 1;
    }

    /* ===== Door / Wheel Lock animation layer ===== */
    .vaultDoors{
      position:absolute;
      inset: 10px;
      border-radius: 16px;
      z-index: 5;
      pointer-events: none; /* toggled in JS when closed */
      transform: translateZ(0);
    }
    .vaultDoor{
      position:absolute;
      top: 0; bottom: 0;
      width: 52%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(900px 420px at 40% 0%, rgba(255,255,255,.07), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.10));
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,.35),
        0 24px 70px rgba(0,0,0,.55);
      opacity: 1;
      will-change: transform, filter;
    }
    .vaultDoor::before{
      content:"";
      position:absolute; inset: 0;
      border-radius: 14px;
      background:
        linear-gradient(90deg, rgba(255,255,255,.08), transparent 22%, transparent 78%, rgba(255,255,255,.06)),
        radial-gradient(800px 320px at 50% -20%, rgba(255,255,255,.08), transparent 62%);
      opacity: .85;
      pointer-events:none;
      mix-blend-mode: screen;
    }
    .vaultDoor::after{
      /* “steel seams” */
      content:"";
      position:absolute; inset: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
      opacity: .9;
    }
    .vaultDoor.left{
      left: 0;
      transform-origin: left center;
      transform: perspective(900px) rotateY(0deg);
    }
    .vaultDoor.right{
      right: 0;
      transform-origin: right center;
      transform: perspective(900px) rotateY(0deg);
    }

    .vaultWheel{
      position:absolute;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%) rotate(0deg);
      width: 82px; height: 82px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(40px 40px at 35% 35%, rgba(255,255,255,.16), transparent 60%),
        radial-gradient(70px 70px at 65% 65%, rgba(0,0,0,.30), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
      box-shadow: 0 20px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(0,0,0,.35);
      opacity: 1;
      will-change: transform, opacity;
    }
    .vaultWheel::before{
      content:"";
      position:absolute; inset: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
    }
    .vaultWheel .spoke{
      position:absolute;
      left: 50%; top: 50%;
      width: 44px; height: 6px;
      transform-origin: 0 50%;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(0,0,0,.18));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .vaultWheel .spoke:nth-child(1){ transform: translate(-2px,-50%) rotate(0deg); }
    .vaultWheel .spoke:nth-child(2){ transform: translate(-2px,-50%) rotate(60deg); }
    .vaultWheel .spoke:nth-child(3){ transform: translate(-2px,-50%) rotate(120deg); }
    .vaultWheel .spoke:nth-child(4){ transform: translate(-2px,-50%) rotate(180deg); }
    .vaultWheel .spoke:nth-child(5){ transform: translate(-2px,-50%) rotate(240deg); }
    .vaultWheel .spoke:nth-child(6){ transform: translate(-2px,-50%) rotate(300deg); }

    /* Closed state (doors blocking interaction) */
    .vaultCabinet.isClosed .vaultDoors{ pointer-events: auto; }
    .vaultCabinet.isClosed .vaultDoor{
      filter: saturate(1.02) contrast(1.02);
    }

    /* Open animation */
    .vaultCabinet.isOpen .vaultDoor.left{
      transform: perspective(900px) rotateY(-78deg);
    }
    .vaultCabinet.isOpen .vaultDoor.right{
      transform: perspective(900px) rotateY(78deg);
    }
    .vaultCabinet.isOpen .vaultWheel{
      transform: translate(-50%,-50%) rotate(320deg);
      opacity: .0;
    }
    .vaultDoor, .vaultWheel{
      transition: transform 900ms cubic-bezier(.2,.9,.2,1), opacity 600ms ease, filter 600ms ease;
    }

    .rackGrid{
      position: relative;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr)); /* shelves 1–4 */
      gap: 12px;
      padding: 14px;
      z-index: 2;
    }
    @media (max-width: 980px){
      .rackGrid{ grid-template-columns: 1fr; }
    }

    .rackBay{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));
      overflow: hidden;
      min-width: 0;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.22);
    }

    .rackBayTop{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }

    /* Engraved plate label */
    .rackPlate{ display:flex; flex-direction: column; gap: 6px; min-width: 0; }
    .rackPlate .name{
      position: relative;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(260px 90px at 30% 0%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.08),
        inset 0 -10px 24px rgba(0,0,0,.45);
      font-size: 11px;
      letter-spacing: .24em;
      text-transform: uppercase;
      font-weight: 900;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      color: rgba(255,255,255,.78);
      text-shadow: 0 1px 0 rgba(0,0,0,.55);
    }
    .rackPlate .name::after{
      /* engraved highlight */
      content:"";
      position:absolute; inset: 0;
      border-radius: 12px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), transparent 40%, rgba(0,0,0,.18));
      opacity: .55;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    .rackPlate .sub{
      font-size: 11px;
      color: rgba(255,255,255,.58);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .rackLed{
      width: 8px; height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.22);
      box-shadow: 0 0 0 4px rgba(255,255,255,.04);
      flex: 0 0 auto;
    }
    .rackLed.gold{ background: rgba(245,200,90,.82); box-shadow: 0 0 0 4px rgba(245,200,90,.10), 0 0 18px rgba(245,200,90,.18); }
    .rackLed.silver{ background: rgba(210,220,232,.82); box-shadow: 0 0 0 4px rgba(210,220,232,.10), 0 0 18px rgba(210,220,232,.14); }
    .rackLed.platinum{ background: rgba(180,195,255,.82); box-shadow: 0 0 0 4px rgba(180,195,255,.10), 0 0 18px rgba(180,195,255,.16); }
    .rackLed.neutral{ background: rgba(142,200,255,.70); box-shadow: 0 0 0 4px rgba(142,200,255,.10), 0 0 18px rgba(142,200,255,.16); }

    .rackMeta{
      display:flex;
      gap: 8px;
      align-items:center;
      color: rgba(255,255,255,.70);
      font-size: 11px;
      white-space: nowrap;
    }
    .rackMeta .chip{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }

    .rackShelf{
      position: relative;
      padding: 12px 12px 12px;
      background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.02));
    }

    .shelfSurface{
      position: relative;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(600px 240px at 50% 0%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, var(--v-steelA), var(--v-steelB));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06), inset 0 -18px 40px rgba(0,0,0,.35);
      overflow: hidden;
      padding: 10px;
    }
    .shelfSurface::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,.06), transparent 20%, transparent 80%, rgba(255,255,255,.04));
      opacity:.8;
      pointer-events:none;
    }
    .shelfLedge{
      content:"";
      position: relative;
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.42));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 24px rgba(0,0,0,.42);
    }

    .slotGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
      min-height: 220px;
    }
    @media (max-width: 520px){
      .slotGrid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

    .slot{
      position: relative;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      min-height: 74px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: border-color .12s ease, background .12s ease, transform .12s ease;
      user-select: none;
    }
    .slot::after{
      content:"";
      position:absolute; inset: 0;
      border-radius: 14px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      pointer-events:none;
      opacity:.8;
    }
    .slotEmptyHint{
      font-size: 11px;
      color: rgba(255,255,255,.45);
      letter-spacing: .08em;
    }
    .slot.isOver{
      border-color: rgba(142,200,255,.45);
      background: rgba(142,200,255,.08);
      transform: translateY(-1px);
      box-shadow: 0 0 0 4px rgba(142,200,255,.10);
    }

    /* =========================================================
       ITEM “OBJECTS”
       ========================================================= */
    .vaultItem{
      width: 100%;
      height: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      cursor: grab;
      overflow: hidden;
      display:flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
    }
    .vaultItem:active{ cursor: grabbing; }
    .vaultItem.isDragging{
      opacity: .72;
      transform: scale(.98);
    }
    .vaultItemTop{
      padding: 8px 9px 6px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 8px;
    }
    .vaultItemName{
      font-size: 11px;
      font-weight: 780;
      letter-spacing: -0.01em;
      line-height: 1.1;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .vaultItemBadge{
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.78);
      flex: 0 0 auto;
    }
    .vaultItemMid{
      padding: 0 9px 8px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .vaultItemStamp{
      font-size: 10px;
      color: rgba(255,255,255,.60);
      letter-spacing: .18em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .vaultItemValue{
      font-size: 11px;
      font-weight: 800;
      color: rgba(255,255,255,.86);
      white-space: nowrap;
    }

    .skinBar::before,
    .skinCoin::before,
    .skinJewelry::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      opacity: .95;
    }
    .skinBar::before{
      background:
        radial-gradient(240px 110px at 30% 0%, rgba(255,255,255,.14), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(0,0,0,.12));
    }
    .skinCoin{ border-radius: 16px; }
    .skinCoin::before{
      background:
        radial-gradient(70px 70px at 35% 35%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(120px 120px at 65% 65%, rgba(0,0,0,.22), transparent 58%);
    }
    .skinJewelry::before{
      background:
        radial-gradient(200px 120px at 50% 10%, rgba(255,255,255,.12), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.05));
    }

    .metalGlowGold{ box-shadow: 0 14px 30px rgba(0,0,0,.35), 0 0 0 1px rgba(245,200,90,.10), 0 0 18px rgba(245,200,90,.08); }
    .metalGlowSilver{ box-shadow: 0 14px 30px rgba(0,0,0,.35), 0 0 0 1px rgba(210,220,232,.10), 0 0 18px rgba(210,220,232,.06); }
    .metalGlowPlatinum{ box-shadow: 0 14px 30px rgba(0,0,0,.35), 0 0 0 1px rgba(180,195,255,.10), 0 0 18px rgba(180,195,255,.07); }

    /* =========================================================
       INSPECT MODAL
       ========================================================= */
    .mmModalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .mmModalBack.isOpen{ display:flex; }
    .mmModal{
      width: min(860px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: 0 26px 110px rgba(0,0,0,.62);
      overflow: hidden;
    }
    .mmModalHead{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .mmModalTitle{
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .mmModalTitle b{
      font-size: 14px;
      letter-spacing: -0.01em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mmModalTitle span{
      font-size: 12px;
      color: rgba(255,255,255,.62);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .mmModalBody{
      padding: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .mmModalBody{ grid-template-columns: 1fr; }
    }
    .mmInspectCard{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
      min-width: 0;
    }
    .mmPhoto{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 220px at 30% 0%, rgba(142,200,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      height: 210px;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.55);
      font-size: 12px;
      letter-spacing: .1em;
      text-transform: uppercase;
      user-select:none;
    }
    .mmKV{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 12px;
      align-items: baseline;
      font-size: 12px;
      color: rgba(255,255,255,.70);
    }
    .mmKV b{ color: rgba(255,255,255,.90); font-weight: 800; }
    .mmModalFoot{
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
  </style>

  <!-- Clerk JS (frontend auth) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
</head>

<body class="vaultPage">
  <div class="meltWrap">

    <!-- Top -->
    <div class="meltTop">
      <div class="meltBrand">
        <div class="meltMark" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 8h12M7 12h10M8 16h8" stroke="rgba(255,255,255,.88)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="meltBrandText">
          <b>MetalMetric</b>
          <span class="mono" id="vaultUpdatedSmall">Vault tool • live spot</span>
        </div>
      </div>

      <div class="meltNav">
        <div class="pillRow" aria-label="Live spot prices (USD per oz t)">
          <div class="pill" id="pillGold" title="Gold spot price ($/oz t)">
            <strong>Gold</strong>
            <span class="mono" id="spotGoldPill">$—</span>
            <small>/ oz t</small>
          </div>
          <div class="pill" id="pillSilver" title="Silver spot price ($/oz t)">
            <strong>Silver</strong>
            <span class="mono" id="spotSilverPill">$—</span>
            <small>/ oz t</small>
          </div>
          <div class="pill" id="pillPlatinum" title="Platinum spot price ($/oz t)">
            <strong>Platinum</strong>
            <span class="mono" id="spotPlatinumPill">$—</span>
            <small>/ oz t</small>
          </div>
          <div class="pill" title="Tier (stub until entitlements)">
            <strong>Tier</strong>
            <span class="mono" id="tierPill">free</span>
          </div>
          <div class="pill" title="Data freshness">
            <strong>Updated</strong>
            <span class="mono" id="chipUpdated">—</span>
          </div>

          <!-- Auth pill -->
          <div class="pill" id="authPill" title="Account" style="display:none;">
            <strong>Account</strong>
            <span class="mono" id="authLabel">—</span>
          </div>
        </div>

        <button class="btn" id="btnRefresh" type="button">Refresh spot</button>

        <!-- Auth buttons -->
        <button class="btn btnPrimary" id="btnSignIn" type="button" style="display:none;">Sign in</button>
        <button class="btn" id="btnSignOut" type="button" style="display:none;">Sign out</button>

        <a class="btn" href="../melt/index.html">Melt</a>
        <a class="btn" href="../index.html">Dashboard</a>
      </div>
    </div>

    <!-- Hero -->
    <div class="meltHero">
      <h1>Vault Tracker</h1>
      <p>
        Track bullion + jewelry melt value live using spot. Drag items between shelves to organize your vault.
      </p>
    </div>

    <div class="meltGrid">
      <!-- INPUT CARD -->
      <section class="card" aria-label="Add item">
        <div class="cardHeader">
          <h2>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 5v14M5 12h14" stroke="rgba(255,255,255,.72)" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Add Item
          </h2>
          <button class="btn" id="btnReset" type="button">Reset</button>
        </div>

        <div class="cardBody">
          <div class="field">
            <label for="label">Label</label>
            <input class="control" id="label" placeholder='e.g., "1 oz Gold Eagle" or "14k ring, 5g"' />
          </div>

          <div class="row">
            <div class="field">
              <label for="metal">Metal</label>
              <select class="control" id="metal">
                <option value="gold">Gold</option>
                <option value="silver">Silver</option>
                <option value="platinum">Platinum</option>
              </select>
            </div>

            <div class="field">
              <label for="itemType">Item type</label>
              <select class="control" id="itemType">
                <option value="bullion">Bullion</option>
                <option value="coin">Coin</option>
                <option value="bar">Bar</option>
                <option value="jewelry">Jewelry</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="weightValue">Weight</label>
              <input class="control mono" id="weightValue" inputmode="decimal" type="number" min="0" step="0.01" placeholder="e.g., 31.1" />
            </div>

            <div class="field">
              <label for="weightUnit">Unit</label>
              <select class="control" id="weightUnit">
                <option value="g" selected>g</option>
                <option value="oz">oz t</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="purityPreset">Purity preset</label>
              <select class="control" id="purityPreset">
                <option value="">Select…</option>
                <option value="0.999">.999 (Fine)</option>
                <option value="0.9167">22k (0.9167)</option>
                <option value="0.900">0.900</option>
                <option value="0.750">18k (0.750)</option>
                <option value="0.585">14k (0.585)</option>
                <option value="0.417">10k (0.417)</option>
              </select>
            </div>

            <div class="field">
              <label for="purity">Purity (0–1)</label>
              <input class="control mono" id="purity" inputmode="decimal" type="number" min="0" max="1" step="0.001" placeholder="e.g., 0.999" />
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="premiumPct">Premium % (optional, for market value)</label>
            <input class="control mono" id="premiumPct" inputmode="decimal" type="number" min="0" step="0.01" placeholder="e.g., 6.5" />
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="notes">Notes (optional)</label>
            <textarea class="control" id="notes" placeholder="Anything you want to remember about this item…"></textarea>
          </div>

          <div class="status" id="statusText">Fetching spot…</div>

          <div class="actionRow">
            <button class="btn btnPrimary" id="btnAdd" type="button">Add to Vault</button>
          </div>

          <div class="status muted" style="margin-top:10px;">
            Jewelry defaults to melt. Bullion/coins can use Premium % later for market valuation + Pro/Elite tools.
          </div>
        </div>
      </section>

      <!-- OUTPUT CARD -->
      <section class="card" aria-label="Vault summary">
        <div class="cardHeader">
          <h2>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 14l5-5 4 4 7-7" stroke="rgba(142,200,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M20 7v6h-6" stroke="rgba(142,200,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Vault Value
          </h2>
          <div class="pill" title="Price basis">
            <strong>USD</strong>
            <span class="mono">/ oz t</span>
          </div>
        </div>

        <div class="resultHero" id="kpiTotal">
          <div class="label">Total Vault Value (Live)</div>
          <div class="value mono" id="totalValue">$—</div>
          <div class="sub mono">
            <span id="summaryLine">—</span>
            <span id="deltaLine" class="deltaFlat">Δ —</span>
          </div>
        </div>

        <div class="kpiRow">
          <div class="kpi">
            <div class="k">Pure oz</div>
            <div class="v mono" id="kPureAll">—</div>
            <div class="s mono" id="kPureSub">Au — • Ag — • Pt —</div>
          </div>
          <div class="kpi">
            <div class="k">Breakdown</div>
            <div class="v mono" id="kBreakdown">—</div>
            <div class="s mono">Gold / Silver / Platinum</div>
          </div>
          <div class="kpi locked" id="kpiLocked" data-locked="false" data-requires="pro">
            <div class="k">Retention hook</div>
            <div class="v mono" id="kHook">Value pulse</div>
            <div class="s mono">Updates every 60s</div>
            <div class="lockOverlay">
              Pro unlocks deeper analytics (history, “since added”, alerts).
            </div>
          </div>
        </div>

        <div class="cardBody" style="padding-top: 0;">
          <div class="vaultRacksWrap">
            <div class="vaultRacksHead">
              <div>
                <div class="title">Vault Racks</div>
                <div class="hint">Tip: drag items between shelves (order saves).</div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
                <button class="btn" id="btnVaultToggle" type="button" title="Open/Close the vault doors">Open vault</button>
                <button class="btn" id="btnFilterToggle" type="button" title="Search & filter your vault">Search / Filter</button>
              </div>
            </div>

            <!-- Search / Filter Drawer -->
            <div class="drawer" id="filterDrawer" aria-label="Search and filter drawer">
              <div class="drawerHead">
                <b>Drawer</b>
                <span class="chipTiny mono" id="filterChip">No filter</span>
              </div>
              <div class="drawerBody">
                <div class="drawerGrid">
                  <div class="field">
                    <label for="filterQuery">Search</label>
                    <input class="control" id="filterQuery" placeholder='Label, notes, ".999", "Eagle", "ring"...' />
                  </div>

                  <div class="field">
                    <label for="filterMetal">Metal</label>
                    <select class="control" id="filterMetal">
                      <option value="">All</option>
                      <option value="gold">Gold</option>
                      <option value="silver">Silver</option>
                      <option value="platinum">Platinum</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="filterType">Item type</label>
                    <select class="control" id="filterType">
                      <option value="">All</option>
                      <option value="bullion">Bullion</option>
                      <option value="coin">Coin</option>
                      <option value="bar">Bar</option>
                      <option value="jewelry">Jewelry</option>
                      <option value="other">Other</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="filterShelf">Shelf</label>
                    <select class="control" id="filterShelf">
                      <option value="">All</option>
                      <option value="Gold">Gold shelf</option>
                      <option value="Silver">Silver shelf</option>
                      <option value="Platinum">Platinum shelf</option>
                      <option value="Overflow">Shelf 4 (Overflow)</option>
                    </select>
                  </div>
                </div>

                <div class="miniHint">
                  Filter affects what’s shown + totals. Drag/drop still saves slot positions to the DB.
                </div>

                <div class="actionRow" style="justify-content:flex-start; margin-top:10px;">
                  <button class="btn" id="btnFilterClear" type="button">Clear</button>
                </div>
              </div>
            </div>

            <div class="vaultCabinet isClosed" id="vaultCabinet">
              <div class="vaultCabinetFrame" aria-hidden="true"></div>

              <!-- Doors + wheel lock overlay -->
              <div class="vaultDoors" aria-hidden="true">
                <div class="vaultDoor left"></div>
                <div class="vaultDoor right"></div>
                <div class="vaultWheel">
                  <span class="spoke"></span><span class="spoke"></span><span class="spoke"></span>
                  <span class="spoke"></span><span class="spoke"></span><span class="spoke"></span>
                </div>
              </div>

              <div class="rackGrid" id="rackGrid">
                <!-- Shelf 1: Gold -->
                <div class="rackBay" data-shelf="Gold">
                  <div class="rackBayTop">
                    <div class="rackPlate">
                      <div class="name"><span class="rackLed gold" aria-hidden="true"></span> GOLD SHELF</div>
                      <div class="sub mono" id="metaGold">—</div>
                    </div>
                    <div class="rackMeta">
                      <span class="chip mono" id="sumGold">$—</span>
                      <span class="chip mono" id="capGold">0/12</span>
                    </div>
                  </div>
                  <div class="rackShelf">
                    <div class="shelfSurface">
                      <div class="slotGrid" id="gridGold"></div>
                    </div>
                    <div class="shelfLedge" aria-hidden="true"></div>
                  </div>
                </div>

                <!-- Shelf 2: Silver -->
                <div class="rackBay" data-shelf="Silver">
                  <div class="rackBayTop">
                    <div class="rackPlate">
                      <div class="name"><span class="rackLed silver" aria-hidden="true"></span> SILVER SHELF</div>
                      <div class="sub mono" id="metaSilver">—</div>
                    </div>
                    <div class="rackMeta">
                      <span class="chip mono" id="sumSilver">$—</span>
                      <span class="chip mono" id="capSilver">0/12</span>
                    </div>
                  </div>
                  <div class="rackShelf">
                    <div class="shelfSurface">
                      <div class="slotGrid" id="gridSilver"></div>
                    </div>
                    <div class="shelfLedge" aria-hidden="true"></div>
                  </div>
                </div>

                <!-- Shelf 3: Platinum -->
                <div class="rackBay" data-shelf="Platinum">
                  <div class="rackBayTop">
                    <div class="rackPlate">
                      <div class="name"><span class="rackLed platinum" aria-hidden="true"></span> PLATINUM SHELF</div>
                      <div class="sub mono" id="metaPlatinum">—</div>
                    </div>
                    <div class="rackMeta">
                      <span class="chip mono" id="sumPlatinum">$—</span>
                      <span class="chip mono" id="capPlatinum">0/12</span>
                    </div>
                  </div>
                  <div class="rackShelf">
                    <div class="shelfSurface">
                      <div class="slotGrid" id="gridPlatinum"></div>
                    </div>
                    <div class="shelfLedge" aria-hidden="true"></div>
                  </div>
                </div>

                <!-- Shelf 4: Overflow / Mixed -->
                <div class="rackBay" data-shelf="Overflow">
                  <div class="rackBayTop">
                    <div class="rackPlate">
                      <div class="name"><span class="rackLed neutral" aria-hidden="true"></span> SHELF 4 — OVERFLOW</div>
                      <div class="sub mono" id="metaOverflow">—</div>
                    </div>
                    <div class="rackMeta">
                      <span class="chip mono" id="sumOverflow">$—</span>
                      <span class="chip mono" id="capOverflow">0/12</span>
                    </div>
                  </div>
                  <div class="rackShelf">
                    <div class="shelfSurface">
                      <div class="slotGrid" id="gridOverflow"></div>
                    </div>
                    <div class="shelfLedge" aria-hidden="true"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="status muted" style="margin-top:10px;">
              Live valuation recalculates using <span class="mono">/api/spot</span>. Items persist in DB via <span class="mono">/api/vault_items</span>.
            </div>
          </div>
        </div>
      </section>
    </div>

  </div>

  <!-- Inspect modal -->
  <div class="mmModalBack" id="inspectBack" aria-hidden="true">
    <div class="mmModal" role="dialog" aria-modal="true" aria-label="Inspect item">
      <div class="mmModalHead">
        <div class="mmModalTitle">
          <b id="insTitle">—</b>
          <span class="mono" id="insSub">—</span>
        </div>
        <button class="btn" id="insClose" type="button">Close</button>
      </div>
      <div class="mmModalBody">
        <div class="mmInspectCard">
          <div class="mmPhoto" id="insPhoto">Photo (Pro/Elite)</div>
          <div class="status muted" style="margin-top:10px;">
            Add photos + certificates as a Pro/Elite upgrade.
          </div>
        </div>

        <div class="mmInspectCard">
          <div class="field">
            <label>Valuation</label>
          </div>
          <div class="mmKV" style="margin-top:6px;">
            <div>Melt</div><b class="mono" id="insMelt">$—</b>
            <div>Market</div><b class="mono" id="insMarket">$—</b>
            <div>Pure oz</div><b class="mono" id="insPure">—</b>
            <div>Premium %</div><b class="mono" id="insPrem">—</b>
            <div>Added</div><b class="mono" id="insAdded">—</b>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="insPremiumEdit">Edit Premium %</label>
            <input class="control mono" id="insPremiumEdit" inputmode="decimal" type="number" min="0" step="0.01" placeholder="e.g., 6.5" />
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="insNotesEdit">Notes</label>
            <textarea class="control" id="insNotesEdit" placeholder="Notes…"></textarea>
          </div>
        </div>
      </div>
      <div class="mmModalFoot">
        <button class="btn btnDanger" id="insDelete" type="button">Delete</button>
        <button class="btn btnPrimary" id="insSave" type="button">Save changes</button>
      </div>
    </div>
  </div>
<!-- DROP-IN PART 2/2: vault/index.html  (the <script> + closing tags) -->
  <script>
    (function () {
      "use strict";

      // ----------------------------
      // Clerk Auth (frontend)
      // ----------------------------
      const btnSignIn = document.getElementById("btnSignIn");
      const btnSignOut = document.getElementById("btnSignOut");
      const authPill = document.getElementById("authPill");
      const authLabel = document.getElementById("authLabel");

      function getClerkPublishableKey() {
        return (localStorage.getItem("clerk_publishable_key") || "").trim();
      }

      async function initClerkIfPossible() {
        const pk = getClerkPublishableKey();
        if (!pk || !window.Clerk) {
          btnSignIn.style.display = "";
          btnSignOut.style.display = "none";
          authPill.style.display = "none";

          btnSignIn.onclick = () => {
            const cur = (localStorage.getItem("clerk_publishable_key") || "").trim();
            const next = prompt(
              "Enter your Clerk Publishable Key (pk_live_... or pk_test_...).\n\nYou can find it in Clerk Dashboard → API Keys.\n\nCurrent:",
              cur
            );
            if (!next) return;
            localStorage.setItem("clerk_publishable_key", next.trim());
            location.reload();
          };

          return false;
        }

        try {
          await window.Clerk.load({ publishableKey: pk });

          btnSignIn.style.display = window.Clerk.user ? "none" : "";
          btnSignOut.style.display = window.Clerk.user ? "" : "none";

          btnSignIn.onclick = () => window.Clerk.openSignIn({});
          btnSignOut.onclick = async () => {
            try { await window.Clerk.signOut(); } catch {}
            location.reload();
          };

          window.Clerk.addListener(() => {
            btnSignIn.style.display = window.Clerk.user ? "none" : "";
            btnSignOut.style.display = window.Clerk.user ? "" : "none";

            if (window.Clerk.user) {
              const email = (window.Clerk.user.primaryEmailAddress && window.Clerk.user.primaryEmailAddress.emailAddress) || "";
              authLabel.textContent = email ? email : ("User " + String(window.Clerk.user.id || "").slice(0, 8));
              authPill.style.display = "";
            } else {
              authPill.style.display = "none";
            }
          });

          if (window.Clerk.user) {
            const email = (window.Clerk.user.primaryEmailAddress && window.Clerk.user.primaryEmailAddress.emailAddress) || "";
            authLabel.textContent = email ? email : ("User " + String(window.Clerk.user.id || "").slice(0, 8));
            authPill.style.display = "";
          } else {
            authPill.style.display = "none";
          }

          return true;
        } catch (e) {
          console.warn("[vault] Clerk init failed:", e);
          btnSignIn.style.display = "";
          btnSignOut.style.display = "none";
          authPill.style.display = "none";
          return false;
        }
      }

      async function getBearerToken() {
        try {
          if (!window.Clerk) return null;
          if (!window.Clerk.session) return null;
          const tok = await window.Clerk.session.getToken();
          return tok || null;
        } catch {
          return null;
        }
      }

      // ----------------------------
      // Existing app code
      // ----------------------------
      const OZ_TROY_IN_G = 31.1034768;
      const el = (id) => document.getElementById(id);

      const pillGold = el("pillGold");
      const pillSilver = el("pillSilver");
      const pillPlatinum = el("pillPlatinum");

      const spotGoldPill = el("spotGoldPill");
      const spotSilverPill = el("spotSilverPill");
      const spotPlatinumPill = el("spotPlatinumPill");

      const chipUpdated = el("chipUpdated");
      const tierPill = el("tierPill");
      const vaultUpdatedSmall = el("vaultUpdatedSmall");

      const btnRefresh = el("btnRefresh");
      const btnReset = el("btnReset");
      const btnAdd = el("btnAdd");

      const labelInput = el("label");
      const metalSelect = el("metal");
      const itemTypeSelect = el("itemType");
      const weightValueInput = el("weightValue");
      const weightUnitSelect = el("weightUnit");
      const purityPresetSelect = el("purityPreset");
      const purityInput = el("purity");
      const premiumPctInput = el("premiumPct");
      const notesInput = el("notes");

      const statusText = el("statusText");

      const kpiTotal = el("kpiTotal");
      const totalValueEl = el("totalValue");
      const summaryLineEl = el("summaryLine");
      const deltaLineEl = el("deltaLine");

      const kPureAll = el("kPureAll");
      const kPureSub = el("kPureSub");
      const kBreakdown = el("kBreakdown");

      // Racks
      const vaultCabinet = el("vaultCabinet");
      const btnVaultToggle = el("btnVaultToggle");
      const btnFilterToggle = el("btnFilterToggle");
      const filterDrawer = el("filterDrawer");
      const filterChip = el("filterChip");
      const filterQuery = el("filterQuery");
      const filterMetal = el("filterMetal");
      const filterType = el("filterType");
      const filterShelf = el("filterShelf");
      const btnFilterClear = el("btnFilterClear");

      const gridGold = el("gridGold");
      const gridSilver = el("gridSilver");
      const gridPlatinum = el("gridPlatinum");
      const gridOverflow = el("gridOverflow");

      const sumGold = el("sumGold");
      const sumSilver = el("sumSilver");
      const sumPlatinum = el("sumPlatinum");
      const sumOverflow = el("sumOverflow");

      const capGold = el("capGold");
      const capSilver = el("capSilver");
      const capPlatinum = el("capPlatinum");
      const capOverflow = el("capOverflow");

      const metaGold = el("metaGold");
      const metaSilver = el("metaSilver");
      const metaPlatinum = el("metaPlatinum");
      const metaOverflow = el("metaOverflow");

      // Inspect modal
      const inspectBack = el("inspectBack");
      const insClose = el("insClose");
      const insTitle = el("insTitle");
      const insSub = el("insSub");
      const insMelt = el("insMelt");
      const insMarket = el("insMarket");
      const insPure = el("insPure");
      const insPrem = el("insPrem");
      const insAdded = el("insAdded");
      const insNotesEdit = el("insNotesEdit");
      const insPremiumEdit = el("insPremiumEdit");
      const insSave = el("insSave");
      const insDelete = el("insDelete");

      function num(v) {
        if (typeof v === "number") return Number.isFinite(v) ? v : NaN;
        if (v == null) return NaN;
        const s = String(v).trim().replace(/,/g, "");
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : NaN;
      }

      const money = (v) => {
        const n = num(v);
        if (!Number.isFinite(n)) return "$—";
        return n.toLocaleString(undefined, { style: "currency", currency: "USD", minimumFractionDigits: 2, maximumFractionDigits: 2 });
      };
      const fmt4 = (v) => Number.isFinite(num(v)) ? num(v).toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 4 }) : "—";
      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

      function escapeHtml(s) {
        return String(s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function setStatus(msg, kind) {
        statusText.textContent = msg;
        statusText.classList.remove("bad", "good", "warn");
        if (kind) statusText.classList.add(kind);
      }

      function getTier() {
        return (localStorage.getItem("mm_tier") || "free").toLowerCase();
      }

      function highlightActiveMetalPill(metal) {
        pillGold.classList.toggle("isActive", metal === "gold");
        pillSilver.classList.toggle("isActive", metal === "silver");
        pillPlatinum.classList.toggle("isActive", metal === "platinum");
      }

      function formatUpdated(v) {
        if (!v) return null;
        const s = String(v);
        const d = new Date(s);
        if (!isNaN(d.getTime())) {
          return d.toLocaleString(undefined, { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
        }
        return s;
      }

      function weightToOzTroy(weightValue, unit) {
        const w = num(weightValue);
        if (!Number.isFinite(w) || w <= 0) return null;
        return unit === "oz" ? w : (w / OZ_TROY_IN_G);
      }

      function computeItemValuation(item, spot) {
        const metal = item.metal;
        const spotPerOz = spot?.[metal]?.usd;
        if (!Number.isFinite(num(spotPerOz))) return { melt: null, market: null, pureOz: null };

        const purity = clamp(num(item.purity || 0), 0, 1);
        const ozTroy = weightToOzTroy(item.weight_value, item.weight_unit);
        if (!ozTroy) return { melt: null, market: null, pureOz: null };

        const pureOz = ozTroy * purity;
        const melt = pureOz * num(spotPerOz);

        const premPct = num(item.premium_pct);
        const hasPrem = Number.isFinite(premPct);
        const market = hasPrem ? (melt * (1 + premPct / 100)) : melt;

        return { melt, market, pureOz, premPct: hasPrem ? premPct : null };
      }

      async function fetchAny(path) {
        const url = path + (path.includes("?") ? "&" : "?") + "ts=" + Date.now();
        const res = await fetch(url, { cache: "no-store", headers: { "Accept": "application/json" } });
        const text = await res.text();

        let data;
        try { data = JSON.parse(text); }
        catch (e) {
          const err = new Error(`Non-JSON from ${path}: ${text.slice(0, 160)}`);
          err.status = res.status;
          err.payload = text;
          throw err;
        }

        if (!res.ok) {
          const msg = (data && data.error) ? String(data.error) : `HTTP ${res.status}`;
          const err = new Error(msg);
          err.status = res.status;
          err.payload = data;
          throw err;
        }
        return data;
      }

      async function fetchVault(path, init) {
        const tok = await getBearerToken();
        if (!tok) throw new Error("Please sign in to use Vault.");
        const headers = Object.assign({}, (init && init.headers) ? init.headers : {});
        headers["Authorization"] = "Bearer " + tok;
        headers["Accept"] = headers["Accept"] || "application/json";
        const url = path + (path.includes("?") ? "&" : "?") + "ts=" + Date.now();
        const res = await fetch(url, Object.assign({}, init || {}, { headers, cache: "no-store" }));
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { ok:false, error: text.slice(0,200) }; }
        if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
        return data;
      }

      function pullSpotFromKnownShape(obj) {
        if (!obj || typeof obj !== "object") return { ok: false, err: "Invalid response" };

        const apiErr = (obj.ok === false)
          ? (obj.error ? String(obj.error) : "Spot returned ok:false")
          : null;

        const gold = [obj.gold_usd, obj?.normalized?.gold, obj.gold, obj?.raw?.gold].map(num).find(Number.isFinite);
        const silver = [obj.silver_usd, obj?.normalized?.silver, obj.silver, obj?.raw?.silver].map(num).find(Number.isFinite);

        const platinum = [
          obj.platinum_usd,
          obj?.normalized?.platinum,
          obj.xpt_usd,
          obj.xpt,
          obj.platinum,
          obj?.raw?.platinum
        ].map(num).find(Number.isFinite);

        const updatedRaw =
          obj.fetched_at_utc ||
          obj.updated_at ||
          obj.updatedAt ||
          obj.date_utc ||
          obj.date ||
          null;

        const anyFound = (gold != null) || (silver != null) || (platinum != null);
        if (!anyFound && apiErr) return { ok: false, err: apiErr };

        return {
          ok: true,
          g: Number.isFinite(gold) ? gold : null,
          s: Number.isFinite(silver) ? silver : null,
          p: Number.isFinite(platinum) ? platinum : null,
          updatedRaw,
          apiErr
        };
      }

      function unwrap(v) {
        if (!v) return null;
        if (Array.isArray(v)) return v[v.length - 1] || null;
        if (typeof v === "object") {
          if (Array.isArray(v.rows)) return v.rows[v.rows.length - 1] || null;
          if (Array.isArray(v.data)) return v.data[v.data.length - 1] || null;
          if (Array.isArray(v.results)) return v.results[v.results.length - 1] || null;
          if (v.latest && typeof v.latest === "object") return v.latest;
        }
        return v;
      }

      async function fetchSpots() {
        setStatus("Fetching live spot…", "");

        try {
          const [spotRes, latestRes] = await Promise.allSettled([
            fetchAny("/api/spot"),
            fetchAny("/api/latest")
          ]);

          const spotRaw = (spotRes.status === "fulfilled") ? spotRes.value : null;
          const latestRaw = (latestRes.status === "fulfilled") ? latestRes.value : null;

          const spot = pullSpotFromKnownShape(unwrap(spotRaw));
          const latest = pullSpotFromKnownShape(unwrap(latestRaw));

          if (spot.ok) {
            if (spot.g != null) state.spots.gold = spot.g;
            if (spot.s != null) state.spots.silver = spot.s;
            if (spot.p != null) state.spots.platinum = spot.p;
            if (spot.updatedRaw) state.updatedAt = formatUpdated(spot.updatedRaw);
            if (spot.apiErr) setStatus("Spot warning: " + spot.apiErr, "warn");
          }

          if (latest.ok) {
            if (state.spots.gold == null && latest.g != null) state.spots.gold = latest.g;
            if (state.spots.silver == null && latest.s != null) state.spots.silver = latest.s;
            if (state.spots.platinum == null && latest.p != null) state.spots.platinum = latest.p;
            if (!state.updatedAt && latest.updatedRaw) state.updatedAt = formatUpdated(latest.updatedRaw);
          }

          if (!state.updatedAt) state.updatedAt = new Date().toISOString();
          updateSpotHeaderUI();

          const active = state.spots.gold || state.spots.silver || state.spots.platinum;
          if (Number.isFinite(num(active))) setStatus("Live spot loaded. Ready.", "good");
          else setStatus("Live spot unavailable. Try refresh.", "warn");

          renderAll();
        } catch (e) {
          console.error("[vault] fetchSpots failed:", e);
          updateSpotHeaderUI();
          setStatus("Spot fetch failed: " + (e?.message || String(e)), "bad");
          renderAll();
        }
      }

      async function postVault(actionBody) {
        return await fetchVault("/api/vault_items", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(actionBody)
        });
      }

      async function loadVaultItems() {
        const j = await fetchVault("/api/vault_items?limit=500");
        state.items = Array.isArray(j.items) ? j.items : [];
      }

      function updateSpotHeaderUI() {
        highlightActiveMetalPill(state.activeMetalForPills());

        spotGoldPill.textContent = money(state.spots.gold);
        spotSilverPill.textContent = money(state.spots.silver);
        spotPlatinumPill.textContent = money(state.spots.platinum);

        chipUpdated.textContent = state.updatedAt || "—";
        vaultUpdatedSmall.textContent = state.updatedAt ? ("Updated • " + state.updatedAt) : "Vault tool • live spot";

        tierPill.textContent = getTier();
      }

      function buildSpotNormalized() {
        return {
          gold: { usd: state.spots.gold },
          silver: { usd: state.spots.silver },
          platinum: { usd: state.spots.platinum },
        };
      }

      // ---- Shelves 1–4
      const SHELF_CAP = 12;
      const SHELVES = ["Gold","Silver","Platinum","Overflow"];

      function shelfNameForMetal(metal){
        if (metal === "gold") return "Gold";
        if (metal === "silver") return "Silver";
        if (metal === "platinum") return "Platinum";
        return "Overflow";
      }

      function normalizedShelf(item){
        const s = (item && item.shelf_section) ? String(item.shelf_section) : shelfNameForMetal(item?.metal);
        return SHELVES.includes(s) ? s : "Overflow";
      }

      function itemSkin(item){
        const t = (item.item_type || "").toLowerCase();
        if (t === "coin") return "skinCoin";
        if (t === "jewelry") return "skinJewelry";
        if (t === "bar" || t === "bullion") return "skinBar";
        return "skinBar";
      }

      function metalGlow(metal){
        if (metal === "gold") return "metalGlowGold";
        if (metal === "silver") return "metalGlowSilver";
        return "metalGlowPlatinum";
      }

      function stampForItem(item){
        const purity = Number.isFinite(num(item.purity)) ? num(item.purity) : null;
        const p = (purity != null) ? (purity >= 0.99 ? ".999" : String(purity.toFixed(3))) : "—";
        const w = Number.isFinite(num(item.weight_value)) ? num(item.weight_value) : null;
        const u = item.weight_unit === "oz" ? "oz t" : "g";
        const wText = (w != null) ? (u === "g" ? w.toFixed(2) : w.toFixed(3)) : "—";
        return `${wText}${u} • ${p}`;
      }

      // ----------------------------
      // Door open/close animation
      // ----------------------------
      function setVaultOpen(isOpen){
        state.vaultOpen = !!isOpen;
        vaultCabinet.classList.toggle("isOpen", state.vaultOpen);
        vaultCabinet.classList.toggle("isClosed", !state.vaultOpen);
        btnVaultToggle.textContent = state.vaultOpen ? "Close vault" : "Open vault";
        // persist preference
        try { localStorage.setItem("mm_vault_open", state.vaultOpen ? "1" : "0"); } catch {}
      }

      btnVaultToggle.addEventListener("click", () => {
        setVaultOpen(!state.vaultOpen);
      });

      // Also open on click anywhere on doors when closed (nice “tap to open”)
      vaultCabinet.addEventListener("click", () => {
        if (!state.vaultOpen) setVaultOpen(true);
      });

      // ----------------------------
      // Search / Filter drawer
      // ----------------------------
      function setDrawerOpen(v){
        state.filterOpen = !!v;
        filterDrawer.classList.toggle("isOpen", state.filterOpen);
      }

      btnFilterToggle.addEventListener("click", () => setDrawerOpen(!state.filterOpen));

      function normalizeQuery(q){
        return String(q || "").trim().toLowerCase();
      }

      function computeFilterChip(){
        const parts = [];
        const q = normalizeQuery(state.filter.q);
        if (q) parts.push(`q:"${q.length > 18 ? q.slice(0,18)+"…" : q}"`);
        if (state.filter.metal) parts.push(state.filter.metal);
        if (state.filter.type) parts.push(state.filter.type);
        if (state.filter.shelf) parts.push(state.filter.shelf);
        return parts.length ? parts.join(" • ") : "No filter";
      }

      function setFilter(next){
        state.filter = Object.assign({}, state.filter, next);
        filterChip.textContent = computeFilterChip();
        renderAll();
      }

      filterQuery.addEventListener("input", () => setFilter({ q: filterQuery.value }));
      filterMetal.addEventListener("change", () => setFilter({ metal: filterMetal.value }));
      filterType.addEventListener("change", () => setFilter({ type: filterType.value }));
      filterShelf.addEventListener("change", () => setFilter({ shelf: filterShelf.value }));

      btnFilterClear.addEventListener("click", () => {
        filterQuery.value = "";
        filterMetal.value = "";
        filterType.value = "";
        filterShelf.value = "";
        setFilter({ q:"", metal:"", type:"", shelf:"" });
      });

      function passesFilter(it){
        const q = normalizeQuery(state.filter.q);
        const m = (state.filter.metal || "").trim().toLowerCase();
        const t = (state.filter.type || "").trim().toLowerCase();
        const s = (state.filter.shelf || "").trim();

        if (m && String(it.metal || "").toLowerCase() !== m) return false;
        if (t && String(it.item_type || "").toLowerCase() !== t) return false;
        if (s && normalizedShelf(it) !== s) return false;

        if (q){
          const hay = [
            it.label,
            it.notes,
            it.item_type,
            it.metal,
            String(it.purity ?? ""),
            String(it.weight_value ?? ""),
            String(it.weight_unit ?? ""),
          ].join(" ").toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      }

      function visibleItems(){
        return state.items.filter(passesFilter);
      }

      function filterIsActive(){
        return !!(normalizeQuery(state.filter.q) || state.filter.metal || state.filter.type || state.filter.shelf);
      }

      // ----------------------------
      // Drag/drop state
      // ----------------------------
      let draggingId = null;

      function setSlotOver(el, v){
        if (!el) return;
        el.classList.toggle("isOver", !!v);
      }

      function buildEmptySlots(container, shelf, cap){
        container.innerHTML = "";
        for (let i=0; i<cap; i++){
          const s = document.createElement("div");
          s.className = "slot";
          s.setAttribute("data-shelf", shelf);
          s.setAttribute("data-slot", String(i));
          s.innerHTML = `<div class="slotEmptyHint">Drop</div>`;

          s.addEventListener("dragover", (e) => { e.preventDefault(); setSlotOver(s, true); });
          s.addEventListener("dragleave", () => setSlotOver(s, false));
          s.addEventListener("drop", async (e) => {
            e.preventDefault();
            setSlotOver(s, false);
            const id = draggingId;
            if (!id) return;
            const toShelf = s.getAttribute("data-shelf");
            const toSlot = parseInt(s.getAttribute("data-slot") || "0", 10);
            await moveItemTo(id, toShelf, toSlot);
          });

          container.appendChild(s);
        }
      }

      function findItemById(id){
        return state.items.find(x => String(x.id) === String(id)) || null;
      }

      function itemsOnShelf(shelf){
        const list = visibleItems(); // drawer affects what we render + totals
        return list.filter(it => normalizedShelf(it) === shelf);
      }

      function slotMapForShelf(shelf){
        const map = new Map();
        for (const it of itemsOnShelf(shelf)){
          const slot = (it.shelf_slot == null) ? null : parseInt(it.shelf_slot, 10);
          if (Number.isFinite(slot)) map.set(slot, it);
        }
        return map;
      }

      async function swapSlots(aId, bId){
        const a = findItemById(aId);
        const b = findItemById(bId);
        if (!a || !b) return;

        const aShelf = normalizedShelf(a);
        const bShelf = normalizedShelf(b);

        const aSlot = (a.shelf_slot == null) ? null : parseInt(a.shelf_slot, 10);
        const bSlot = (b.shelf_slot == null) ? null : parseInt(b.shelf_slot, 10);

        await postVault({ action: "update", id: a.id, shelf_section: bShelf, shelf_slot: bSlot });
        await postVault({ action: "update", id: b.id, shelf_section: aShelf, shelf_slot: aSlot });
      }

      async function moveItemTo(id, shelf, slot){
        const item = findItemById(id);
        if (!item) return;

        const targetShelf = SHELVES.includes(String(shelf)) ? String(shelf) : "Overflow";
        const targetSlot = clamp(parseInt(slot,10) || 0, 0, SHELF_CAP-1);

        const map = slotMapForShelf(targetShelf);
        const occupant = map.get(targetSlot);
        if (occupant && String(occupant.id) !== String(id)){
          try{
            setStatus("Reordering…", "");
            await swapSlots(id, occupant.id);
          }catch(e){
            setStatus("Move failed: " + (e?.message || String(e)), "bad");
          }finally{
            await refreshVaultOnly();
            renderAll();
          }
          return;
        }

        try{
          setStatus("Saving shelf position…", "");
          await postVault({ action: "update", id: item.id, shelf_section: targetShelf, shelf_slot: targetSlot });
          await refreshVaultOnly();
          setStatus("Saved.", "good");
        }catch(e){
          setStatus("Move failed: " + (e?.message || String(e)), "bad");
        }finally{
          renderAll();
        }
      }

      function openInspect(item, valuation){
        if (!item) return;
        state.inspectingId = String(item.id);

        const shelf = normalizedShelf(item);
        const slot = (item.shelf_slot == null) ? "—" : String(item.shelf_slot);

        insTitle.textContent = item.label || "—";
        insSub.textContent = `${(item.metal || "—").toUpperCase()} • ${item.item_type || "—"} • Shelf ${shelf} • Slot ${slot}`;

        insMelt.textContent = money(valuation?.melt);
        insMarket.textContent = money(valuation?.market);
        insPure.textContent = fmt4(valuation?.pureOz);
        insPrem.textContent = (valuation?.premPct == null) ? "—" : String(valuation.premPct.toFixed(2));
        insAdded.textContent = item.created_at ? formatUpdated(item.created_at) : "—";

        insNotesEdit.value = item.notes || "";
        insPremiumEdit.value = (item.premium_pct == null || !Number.isFinite(num(item.premium_pct))) ? "" : String(num(item.premium_pct));

        inspectBack.classList.add("isOpen");
        inspectBack.setAttribute("aria-hidden", "false");
      }

      function closeInspect(){
        inspectBack.classList.remove("isOpen");
        inspectBack.setAttribute("aria-hidden", "true");
        state.inspectingId = null;
      }

      insClose.addEventListener("click", closeInspect);
      inspectBack.addEventListener("click", (e) => {
        if (e.target === inspectBack) closeInspect();
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && inspectBack.classList.contains("isOpen")) closeInspect();
      });

      insSave.addEventListener("click", async () => {
        const id = state.inspectingId;
        if (!id) return;

        const premRaw = (insPremiumEdit.value || "").trim();
        const prem = premRaw === "" ? null : num(premRaw);
        const notes = (insNotesEdit.value || "").trim();

        if (prem != null && (!Number.isFinite(prem) || prem < 0 || prem > 500)){
          alert("Premium % must be 0–500.");
          return;
        }

        insSave.disabled = true;
        try{
          await postVault({ action: "update", id, premium_pct: prem, notes });
          await refreshVaultOnly();
          setStatus("Saved item changes.", "good");
          renderAll();
          closeInspect();
        }catch(e){
          alert(e?.message || String(e));
        }finally{
          insSave.disabled = false;
        }
      });

      insDelete.addEventListener("click", async () => {
        const id = state.inspectingId;
        if (!id) return;
        if (!confirm("Delete this item?")) return;

        insDelete.disabled = true;
        try{
          await postVault({ action: "delete", id });
          await refreshVaultOnly();
          setStatus("Deleted.", "good");
          renderAll();
          closeInspect();
        }catch(e){
          alert(e?.message || String(e));
        }finally{
          insDelete.disabled = false;
        }
      });

      function renderShelfGrid(container, shelf, spot){
        buildEmptySlots(container, shelf, SHELF_CAP);

        const map = slotMapForShelf(shelf);

        const used = new Set(Array.from(map.keys()));
        const loose = itemsOnShelf(shelf).filter(it => it.shelf_slot == null || !Number.isFinite(parseInt(it.shelf_slot,10)));

        let cursor = 0;
        for (const it of loose){
          while (used.has(cursor) && cursor < SHELF_CAP) cursor++;
          if (cursor >= SHELF_CAP) break;
          map.set(cursor, it);
          used.add(cursor);
          cursor++;
        }

        for (const [slot, it] of map.entries()){
          if (slot < 0 || slot >= SHELF_CAP) continue;
          const slotEl = container.querySelector(`.slot[data-shelf="${shelf}"][data-slot="${slot}"]`);
          if (!slotEl) continue;

          const v = computeItemValuation(it, spot);
          const badge = (it.item_type || "item").toUpperCase();

          const div = document.createElement("div");
          div.className = `vaultItem ${itemSkin(it)} ${metalGlow(it.metal)}`;
          div.setAttribute("draggable", "true");
          div.setAttribute("data-id", String(it.id));
          div.setAttribute("title", "Drag to move • Click to inspect");

          div.innerHTML = `
            <div class="vaultItemTop">
              <div class="vaultItemName">${escapeHtml(it.label || "—")}</div>
              <div class="vaultItemBadge">${escapeHtml(badge)}</div>
            </div>
            <div class="vaultItemMid">
              <div class="vaultItemStamp mono">${escapeHtml(stampForItem(it))}</div>
              <div class="vaultItemValue mono">${escapeHtml(money(v.market))}</div>
            </div>
          `;

          div.addEventListener("dragstart", () => {
            draggingId = String(it.id);
            div.classList.add("isDragging");
          });
          div.addEventListener("dragend", () => {
            draggingId = null;
            div.classList.remove("isDragging");
          });

          div.addEventListener("click", () => openInspect(it, v));

          slotEl.innerHTML = "";
          slotEl.appendChild(div);

          slotEl.addEventListener("dragover", (e) => { e.preventDefault(); setSlotOver(slotEl, true); });
          slotEl.addEventListener("dragleave", () => setSlotOver(slotEl, false));
          slotEl.addEventListener("drop", async (e) => {
            e.preventDefault();
            setSlotOver(slotEl, false);
            const id = draggingId;
            if (!id) return;

            const toShelf = slotEl.getAttribute("data-shelf");
            const toSlot = parseInt(slotEl.getAttribute("data-slot") || "0", 10);
            await moveItemTo(id, toShelf, toSlot);
          });
        }
      }

      function renderAll() {
        const spot = buildSpotNormalized();
        const vis = visibleItems();

        let totals = { gold: 0, silver: 0, platinum: 0 };
        let pureOz = { gold: 0, silver: 0, platinum: 0 };
        let totalMarket = 0;

        for (const item of vis) {
          const v = computeItemValuation(item, spot);
          const m = item.metal;

          if (Number.isFinite(num(v.market))) {
            totalMarket += num(v.market);
            if (totals[m] != null) totals[m] += num(v.market);
          }
          if (Number.isFinite(num(v.pureOz)) && pureOz[m] != null) pureOz[m] += num(v.pureOz);
        }

        totalValueEl.textContent = money(totalMarket);

        const allPure = pureOz.gold + pureOz.silver + pureOz.platinum;
        kPureAll.textContent = fmt4(allPure);
        kPureSub.textContent = `Au ${fmt4(pureOz.gold)} • Ag ${fmt4(pureOz.silver)} • Pt ${fmt4(pureOz.platinum)}`;

        kBreakdown.textContent = `${money(totals.gold)} / ${money(totals.silver)} / ${money(totals.platinum)}`;

        const countText = `${vis.length} item${vis.length === 1 ? "" : "s"}`;
        summaryLineEl.textContent = filterIsActive()
          ? `${countText} • filtered view • drag to organize • updates every 60s`
          : `${countText} • drag to organize • updates every 60s`;

        if (state.lastTotal != null && Number.isFinite(num(totalMarket))) {
          const d = num(totalMarket) - num(state.lastTotal);
          const abs = Math.abs(d);
          const cls = abs < 0.01 ? "deltaFlat" : (d > 0 ? "deltaUp" : "deltaDown");
          deltaLineEl.className = cls;
          deltaLineEl.textContent = abs < 0.01 ? "Δ —" : `Δ ${money(d)}`;

          if (abs > 0.01) {
            kpiTotal.classList.remove("pulse");
            void kpiTotal.offsetWidth;
            kpiTotal.classList.add("pulse");
          }
        } else {
          deltaLineEl.className = "deltaFlat";
          deltaLineEl.textContent = "Δ —";
        }

        state.lastTotal = totalMarket;

        const tier = getTier();
        const locked = (tier === "free");
        const kpiLocked = el("kpiLocked");
        kpiLocked.setAttribute("data-locked", locked ? "true" : "false");

        // Shelf summaries (counts + shelf totals)
        function shelfTotals(shelf){
          let sum = 0;
          for (const it of itemsOnShelf(shelf)){
            const v = computeItemValuation(it, spot);
            if (Number.isFinite(num(v.market))) sum += num(v.market);
          }
          return sum;
        }

        sumGold.textContent = money(shelfTotals("Gold"));
        sumSilver.textContent = money(shelfTotals("Silver"));
        sumPlatinum.textContent = money(shelfTotals("Platinum"));
        sumOverflow.textContent = money(shelfTotals("Overflow"));

        const gCount = itemsOnShelf("Gold").length;
        const sCount = itemsOnShelf("Silver").length;
        const pCount = itemsOnShelf("Platinum").length;
        const oCount = itemsOnShelf("Overflow").length;

        capGold.textContent = `${gCount}/${SHELF_CAP}`;
        capSilver.textContent = `${sCount}/${SHELF_CAP}`;
        capPlatinum.textContent = `${pCount}/${SHELF_CAP}`;
        capOverflow.textContent = `${oCount}/${SHELF_CAP}`;

        metaGold.textContent = `Au items • ${fmt4(pureOz.gold)} oz`;
        metaSilver.textContent = `Ag items • ${fmt4(pureOz.silver)} oz`;
        metaPlatinum.textContent = `Pt items • ${fmt4(pureOz.platinum)} oz`;
        metaOverflow.textContent = `Mixed storage • ${oCount} item${oCount === 1 ? "" : "s"}`;

        // Render shelves
        renderShelfGrid(gridGold, "Gold", spot);
        renderShelfGrid(gridSilver, "Silver", spot);
        renderShelfGrid(gridPlatinum, "Platinum", spot);
        renderShelfGrid(gridOverflow, "Overflow", spot);
      }

      const state = {
        items: [],
        spots: { gold: null, silver: null, platinum: null },
        updatedAt: null,
        lastTotal: null,
        inspectingId: null,
        activeMetalForPills: () => "gold",
        vaultOpen: false,
        filterOpen: false,
        filter: { q:"", metal:"", type:"", shelf:"" }
      };

      purityPresetSelect.addEventListener("change", () => {
        if (purityPresetSelect.value) purityInput.value = purityPresetSelect.value;
      });

      btnRefresh.addEventListener("click", fetchSpots);

      btnReset.addEventListener("click", () => {
        labelInput.value = "";
        metalSelect.value = "gold";
        itemTypeSelect.value = "bullion";
        weightValueInput.value = "";
        weightUnitSelect.value = "g";
        purityPresetSelect.value = "";
        purityInput.value = "";
        premiumPctInput.value = "";
        notesInput.value = "";
        setStatus("Reset.", "");
      });

      btnAdd.addEventListener("click", async () => {
        const metal = metalSelect.value;
        const shelf_section = shelfNameForMetal(metal);

        const payload = {
          action: "create",
          label: (labelInput.value || "").trim(),
          metal,
          item_type: itemTypeSelect.value,
          weight_value: num(weightValueInput.value),
          weight_unit: weightUnitSelect.value,
          purity: num(purityInput.value),
          premium_pct: (premiumPctInput.value || "").trim() === "" ? null : num(premiumPctInput.value),
          notes: (notesInput.value || "").trim(),
          source: "manual",
          shelf_section
          // shelf_slot auto-assigns server-side if omitted
        };

        if (!payload.label) return setStatus("Add a label (what is this item?).", "bad");
        if (!Number.isFinite(payload.weight_value) || payload.weight_value <= 0) return setStatus("Weight must be a positive number.", "bad");
        if (!Number.isFinite(payload.purity) || payload.purity <= 0 || payload.purity > 1) return setStatus("Purity must be between 0 and 1.", "bad");
        if (payload.premium_pct != null && (!Number.isFinite(payload.premium_pct) || payload.premium_pct < 0 || payload.premium_pct > 500)) {
          return setStatus("Premium % must be a reasonable number (0–500).", "bad");
        }

        btnAdd.disabled = true;
        try {
          await postVault(payload);
          setStatus("Added to vault.", "good");
          labelInput.value = "";
          weightValueInput.value = "";
          notesInput.value = "";
          await refreshVaultOnly();
          renderAll();
        } catch (e) {
          setStatus("Add failed: " + (e?.message || String(e)), "bad");
        } finally {
          btnAdd.disabled = false;
        }
      });

      async function refreshVaultOnly() {
        try {
          await loadVaultItems();
        } catch (e) {
          setStatus(e?.message ? String(e.message) : "Sign in to load vault items.", "warn");
          state.items = [];
        }
      }

      async function refreshAll() {
        tierPill.textContent = getTier();
        await Promise.allSettled([refreshVaultOnly(), fetchSpots()]);
        updateSpotHeaderUI();
        renderAll();
      }

      (async function init() {
        setStatus("Fetching live spot…", "");

        await new Promise((r) => setTimeout(r, 0));
        await initClerkIfPossible();

        // Restore vault open state
        const savedOpen = (localStorage.getItem("mm_vault_open") || "0") === "1";
        setVaultOpen(savedOpen);

        // Drawer default closed, chip correct
        filterChip.textContent = "No filter";

        await refreshAll();

        // Optional: a tiny “unlock moment” once on first load (still respecting saved state)
        if (!savedOpen){
          // quick wheel jiggle without opening (subtle)
          // (no-op; leaving simple to avoid over-animating)
        }

        setInterval(() => { fetchSpots().catch(() => {}); }, 60_000);
      })();
    })();
  </script>
</body>
</html>
