<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vault Tracker — MetalMetric</title>

  <link rel="stylesheet" href="../styles.css" />
  <link rel="icon" href="../icon.svg" />

  <style>
    :root{
      --m-bg: #0b0f14;
      --m-panel: rgba(255,255,255,.04);
      --m-panel2: rgba(255,255,255,.06);
      --m-border: rgba(255,255,255,.10);
      --m-border2: rgba(255,255,255,.14);
      --m-text: rgba(255,255,255,.92);
      --m-subtext: rgba(255,255,255,.64);
      --m-muted: rgba(255,255,255,.50);
      --m-shadow: 0 18px 60px rgba(0,0,0,.50);
      --m-radius: 18px;
      --m-radius2: 14px;

      --m-accent: rgba(142, 200, 255, 1);
      --m-gold: rgba(245, 200, 90, 1);
      --m-silver: rgba(210, 220, 232, 1);
      --m-plat: rgba(180, 195, 255, 1);

      --m-good: rgba(52, 211, 153, 1);
      --m-bad: rgba(248, 113, 113, 1);
      --m-warn: rgba(251, 191, 36, 1);
    }

    body.vaultPage{
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(142,200,255,.12), transparent 60%),
        radial-gradient(900px 520px at 80% 0%, rgba(245,200,90,.10), transparent 60%),
        var(--m-bg);
      color: var(--m-text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      overflow-x: hidden;
    }

    body.vaultPage a{ color: inherit; text-decoration: none; }
    body.vaultPage a:hover{ text-decoration: underline; text-decoration-color: rgba(255,255,255,.35); }

    .mono{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }

    .meltWrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    .meltTop{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 18px;
    }
    .meltBrand{
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 220px;
    }
    .meltMark{
      width: 34px; height: 34px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.04));
      border: 1px solid var(--m-border);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      display: grid; place-items: center;
    }
    .meltMark svg{ opacity: .92; }
    .meltBrandText{ display: flex; flex-direction: column; line-height: 1.1; }
    .meltBrandText b{ font-size: 14px; letter-spacing: .2px; }
    .meltBrandText span{ font-size: 12px; color: var(--m-subtext); }

    .meltNav{
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pillRow{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--m-border);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      color: rgba(255,255,255,.86);
      font-size: 12px;
      white-space: nowrap;
      user-select: none;
    }
    .pill strong{ font-weight: 650; letter-spacing: .2px; }
    .pill small{ color: var(--m-subtext); font-size: 11px; }
    .pill.isActive{
      background: rgba(142,200,255,.08);
      border-color: rgba(142,200,255,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.25), 0 0 0 4px rgba(142,200,255,.08);
    }

    .btn{
      appearance: none;
      border: 1px solid var(--m-border);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      padding: 9px 11px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.28);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select: none;
    }
    .btn:hover{ background: rgba(255,255,255,.09); border-color: var(--m-border2); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 4px rgba(142,200,255,.18), 0 18px 60px rgba(0,0,0,.35);
      border-color: rgba(142,200,255,.45);
    }
    .btnPrimary{
      border-color: rgba(142,200,255,.35);
      background: rgba(142,200,255,.12);
    }
    .btnPrimary:hover{
      background: rgba(142,200,255,.18);
      border-color: rgba(142,200,255,.48);
    }
    .btnDanger{
      border-color: rgba(248,113,113,.30);
      background: rgba(248,113,113,.10);
    }
    .btnDanger:hover{
      background: rgba(248,113,113,.14);
      border-color: rgba(248,113,113,.45);
    }
    .btn:disabled{
      opacity: .55;
      cursor: not-allowed;
      transform: none !important;
    }

    .meltHero{
      margin: 12px 0 22px;
      padding: 18px 18px 0;
    }
    .meltHero h1{
      margin: 0 0 6px;
      font-size: 28px;
      letter-spacing: -0.02em;
    }
    .meltHero p{
      margin: 0;
      color: var(--m-subtext);
      font-size: 14px;
      line-height: 1.45;
    }

    .meltGrid{
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 980px){
      .meltGrid{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--m-radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--m-border);
      box-shadow: var(--m-shadow);
      overflow: hidden;
      min-width: 0;
    }
    .cardHeader{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .cardHeader h2{
      margin: 0;
      font-size: 13px;
      letter-spacing: .3px;
      font-weight: 650;
      color: rgba(255,255,255,.86);
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .cardBody{ padding: 16px; }

    .row{
      display: grid;
      grid-template-columns: 1fr 160px;
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .row{ grid-template-columns: 1fr 160px; }
    }
    @media (max-width: 560px){
      .row{ grid-template-columns: 1fr; }
    }
    .field label{
      display: block;
      font-size: 11px;
      color: var(--m-subtext);
      margin-bottom: 6px;
      letter-spacing: .2px;
    }
    .control{
      width: 100%;
      border-radius: 12px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.90);
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
      transition: border-color .12s ease, box-shadow .12s ease, background .12s ease;
      box-sizing: border-box;
    }
    .control:hover{ border-color: rgba(255,255,255,.16); }
    .control:focus{
      border-color: rgba(142,200,255,.50);
      box-shadow: 0 0 0 4px rgba(142,200,255,.14);
      background: rgba(255,255,255,.06);
    }
    select.control{ padding-right: 34px; }
    textarea.control{ min-height: 84px; resize: vertical; }

    .resultHero{
      padding: 18px 16px 12px;
      background: linear-gradient(180deg, rgba(142,200,255,.10), rgba(255,255,255,.00));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .resultHero .label{
      font-size: 11px;
      color: rgba(255,255,255,.65);
      letter-spacing: .28em;
      text-transform: uppercase;
    }
    .resultHero .value{
      margin-top: 8px;
      font-size: 44px;
      font-weight: 760;
      letter-spacing: -0.03em;
      line-height: 1.0;
    }
    .resultHero .sub{
      margin-top: 8px;
      color: var(--m-subtext);
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      min-height: 18px;
    }
    .deltaUp{ color: rgba(52,211,153,.95); }
    .deltaDown{ color: rgba(248,113,113,.95); }
    .deltaFlat{ color: rgba(255,255,255,.62); }

    .kpiRow{
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      padding: 14px 16px 16px;
    }
    @media (max-width: 980px){
      .kpiRow{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .kpi{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px 12px;
      min-width: 0;
    }
    .kpi .k{ font-size: 10px; color: rgba(255,255,255,.58); letter-spacing: .22em; text-transform: uppercase; }
    .kpi .v{ margin-top: 6px; font-size: 16px; font-weight: 720; letter-spacing: -0.01em; }
    .kpi .s{ margin-top: 2px; font-size: 11px; color: rgba(255,255,255,.62); }

    .status{
      font-size: 12px;
      color: var(--m-subtext);
      min-height: 18px;
      margin-top: 10px;
    }
    .status.bad{ color: rgba(248,113,113,.95); }
    .status.good{ color: rgba(52,211,153,.95); }
    .status.warn{ color: rgba(251,191,36,.95); }

    .actionRow{
      margin-top: 12px;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
      width: 100%;
    }

    .pulse { animation: mmPulse 650ms ease; }
    @keyframes mmPulse {
      0% { box-shadow: none; }
      35% { box-shadow: 0 0 0 4px rgba(142,200,255,.16), 0 18px 60px rgba(0,0,0,.35); }
      100% { box-shadow: none; }
    }

    /* ===========================
       SHELVES GRID (DRAG/DROP)
       =========================== */
    .shelvesWrap{
      padding: 0 16px 16px;
    }

    .shelvesTopRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding: 12px 0 10px;
    }
    .shelvesHint{
      color: rgba(255,255,255,.62);
      font-size: 12px;
    }

    .shelvesGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .shelvesGrid{ grid-template-columns: 1fr; }
    }

    .shelf{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      overflow:hidden;
      min-width:0;
      box-shadow: 0 12px 36px rgba(0,0,0,.30);
    }

    .shelfHead{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }

    .shelfTitle{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .shelfTitle b{
      font-size: 12px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,.82);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .shelfTitle span{
      font-size: 11px;
      color: rgba(255,255,255,.58);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .shelfTotals{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:2px;
      min-width: 0;
    }
    .shelfTotals .t1{ font-size: 12px; font-weight: 720; }
    .shelfTotals .t2{ font-size: 11px; color: rgba(255,255,255,.58); }

    .shelfBody{
      padding: 10px;
      min-height: 86px;
    }

    .dropZone{
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-height: 66px;
      border-radius: 14px;
      padding: 8px;
      border: 1px dashed rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
      transition: background .12s ease, border-color .12s ease;
    }
    .dropZone.isOver{
      border-color: rgba(142,200,255,.40);
      background: rgba(142,200,255,.06);
    }

    .vaultCard{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 10px;
      cursor: grab;
      user-select:none;
      min-width:0;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      transition: transform .10s ease, border-color .12s ease, background .12s ease, opacity .12s ease;
    }
    .vaultCard:active{ cursor: grabbing; }
    .vaultCard:hover{ border-color: rgba(255,255,255,.16); background: rgba(255,255,255,.05); transform: translateY(-1px); }

    .vaultCard.isDragging{
      opacity: .55;
      transform: scale(.99);
    }

    .vaultCardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .vaultCardName{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .vaultCardName b{
      font-size: 13px;
      letter-spacing: -0.01em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .vaultCardName span{
      font-size: 11px;
      color: rgba(255,255,255,.58);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .vaultCardMeta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .metaPill{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 7px 8px;
      min-width:0;
    }
    .metaPill .k{ font-size: 10px; letter-spacing: .18em; text-transform: uppercase; color: rgba(255,255,255,.55); }
    .metaPill .v{ margin-top: 2px; font-size: 12px; font-weight: 720; }

    .vaultCardActions{
      display:flex;
      gap:6px;
      align-items:center;
      justify-content:flex-end;
      margin-top: 8px;
    }

    .miniBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 11px;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease, transform .10s ease;
    }
    .miniBtn:hover{ background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.18); transform: translateY(-1px); }
    .miniBtn:active{ transform: translateY(0); }
    .miniBtn--danger{
      border-color: rgba(248,113,113,.28);
      background: rgba(248,113,113,.10);
    }
    .miniBtn--danger:hover{
      border-color: rgba(248,113,113,.45);
      background: rgba(248,113,113,.14);
    }

    .emptyShelf{
      color: rgba(255,255,255,.58);
      font-size: 12px;
      padding: 12px 10px;
      text-align:center;
    }

    /* Retention hook overlay (kept) */
    .locked{ position: relative; filter: blur(0); }
    .locked[data-locked="true"]{ filter: blur(0.2px); }
    .lockOverlay{
      display: none;
      position: absolute;
      inset: 0;
      border-radius: 14px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      align-items: center;
      justify-content: center;
      padding: 12px;
      text-align: center;
      color: rgba(255,255,255,.88);
      font-size: 13px;
    }
    .locked[data-locked="true"] .lockOverlay{ display: flex; }
  </style>

  <!-- Clerk JS (frontend auth) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
</head>

<body class="vaultPage">
  <div class="meltWrap">

    <!-- Top -->
    <div class="meltTop">
      <div class="meltBrand">
        <div class="meltMark" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 8h12M7 12h10M8 16h8" stroke="rgba(255,255,255,.88)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="meltBrandText">
          <b>MetalMetric</b>
          <span class="mono" id="vaultUpdatedSmall">Vault tool • live spot</span>
        </div>
      </div>

      <div class="meltNav">
        <div class="pillRow" aria-label="Live spot prices (USD per oz t)">
          <div class="pill" id="pillGold" title="Gold spot price ($/oz t)">
            <strong>Gold</strong>
            <span class="mono" id="spotGoldPill">$—</span>
            <small>/ oz t</small>
          </div>
          <div class="pill" id="pillSilver" title="Silver spot price ($/oz t)">
            <strong>Silver</strong>
            <span class="mono" id="spotSilverPill">$—</span>
            <small>/ oz t</small>
          </div>
          <div class="pill" id="pillPlatinum" title="Platinum spot price ($/oz t)">
            <strong>Platinum</strong>
            <span class="mono" id="spotPlatinumPill">$—</span>
            <small>/ oz t</small>
          </div>
          <div class="pill" title="Tier (stub until entitlements)">
            <strong>Tier</strong>
            <span class="mono" id="tierPill">free</span>
          </div>
          <div class="pill" title="Data freshness">
            <strong>Updated</strong>
            <span class="mono" id="chipUpdated">—</span>
          </div>

          <!-- Auth pill -->
          <div class="pill" id="authPill" title="Account" style="display:none;">
            <strong>Account</strong>
            <span class="mono" id="authLabel">—</span>
          </div>
        </div>

        <button class="btn" id="btnRefresh" type="button">Refresh spot</button>

        <!-- Auth buttons -->
        <button class="btn btnPrimary" id="btnSignIn" type="button" style="display:none;">Sign in</button>
        <button class="btn" id="btnSignOut" type="button" style="display:none;">Sign out</button>

        <a class="btn" href="../melt/index.html">Melt</a>
        <a class="btn" href="../index.html">Dashboard</a>
      </div>
    </div>

    <!-- Hero -->
    <div class="meltHero">
      <h1>Vault Tracker</h1>
      <p>
        Track bullion + jewelry melt value live using spot. Drag cards between shelves to organize your vault.
      </p>
    </div>

    <div class="meltGrid">
      <!-- INPUT CARD -->
      <section class="card" aria-label="Add item">
        <div class="cardHeader">
          <h2>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 5v14M5 12h14" stroke="rgba(255,255,255,.72)" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Add Item
          </h2>
          <button class="btn" id="btnReset" type="button">Reset</button>
        </div>

        <div class="cardBody">
          <div class="field">
            <label for="label">Label</label>
            <input class="control" id="label" placeholder='e.g., "1 oz Gold Eagle" or "14k ring, 5g"' />
          </div>

          <div class="row">
            <div class="field">
              <label for="metal">Metal</label>
              <select class="control" id="metal">
                <option value="gold">Gold</option>
                <option value="silver">Silver</option>
                <option value="platinum">Platinum</option>
              </select>
            </div>

            <div class="field">
              <label for="itemType">Item type</label>
              <select class="control" id="itemType">
                <option value="bullion">Bullion</option>
                <option value="coin">Coin</option>
                <option value="bar">Bar</option>
                <option value="jewelry">Jewelry</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="weightValue">Weight</label>
              <input class="control mono" id="weightValue" inputmode="decimal" type="number" min="0" step="0.01" placeholder="e.g., 31.1" />
            </div>

            <div class="field">
              <label for="weightUnit">Unit</label>
              <select class="control" id="weightUnit">
                <option value="g" selected>g</option>
                <option value="oz">oz t</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="purityPreset">Purity preset</label>
              <select class="control" id="purityPreset">
                <option value="">Select…</option>
                <option value="0.999">.999 (Fine)</option>
                <option value="0.9167">22k (0.9167)</option>
                <option value="0.900">0.900</option>
                <option value="0.750">18k (0.750)</option>
                <option value="0.585">14k (0.585)</option>
                <option value="0.417">10k (0.417)</option>
              </select>
            </div>

            <div class="field">
              <label for="purity">Purity (0–1)</label>
              <input class="control mono" id="purity" inputmode="decimal" type="number" min="0" max="1" step="0.001" placeholder="e.g., 0.999" />
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="premiumPct">Premium % (optional, for market value)</label>
            <input class="control mono" id="premiumPct" inputmode="decimal" type="number" min="0" step="0.01" placeholder="e.g., 6.5" />
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="notes">Notes (optional)</label>
            <textarea class="control" id="notes" placeholder="Anything you want to remember about this item…"></textarea>
          </div>

          <div class="status" id="statusText">Fetching spot…</div>

          <div class="actionRow">
            <button class="btn btnPrimary" id="btnAdd" type="button">Add to Vault</button>
          </div>

          <div class="status muted" style="margin-top:10px;">
            Jewelry defaults to melt. Drag items between shelves to organize.
          </div>
        </div>
      </section>

      <!-- OUTPUT CARD -->
      <section class="card" aria-label="Vault summary">
        <div class="cardHeader">
          <h2>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 14l5-5 4 4 7-7" stroke="rgba(142,200,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M20 7v6h-6" stroke="rgba(142,200,255,.85)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Vault Value
          </h2>
          <div class="pill" title="Price basis">
            <strong>USD</strong>
            <span class="mono">/ oz t</span>
          </div>
        </div>

        <div class="resultHero" id="kpiTotal">
          <div class="label">Total Vault Value (Live)</div>
          <div class="value mono" id="totalValue">$—</div>
          <div class="sub mono">
            <span id="summaryLine">—</span>
            <span id="deltaLine" class="deltaFlat">Δ —</span>
          </div>
        </div>

        <div class="kpiRow">
          <div class="kpi">
            <div class="k">Pure oz</div>
            <div class="v mono" id="kPureAll">—</div>
            <div class="s mono" id="kPureSub">Au — • Ag — • Pt —</div>
          </div>
          <div class="kpi">
            <div class="k">Breakdown</div>
            <div class="v mono" id="kBreakdown">—</div>
            <div class="s mono">Gold / Silver / Platinum</div>
          </div>
          <div class="kpi locked" id="kpiLocked" data-locked="false" data-requires="pro">
            <div class="k">Retention hook</div>
            <div class="v mono" id="kHook">Value pulse</div>
            <div class="s mono">Updates every 60s</div>
            <div class="lockOverlay">
              Pro unlocks deeper analytics (history, “since added”, alerts).
            </div>
          </div>
        </div>

        <!-- Shelves UI -->
        <div class="shelvesWrap">
          <div class="shelvesTopRow">
            <div class="field" style="margin:0;">
              <label style="margin:0;">Shelves</label>
            </div>
            <div class="shelvesHint">Tip: drag cards between shelves (order is saved locally).</div>
          </div>

          <div class="shelvesGrid" id="shelvesGrid" aria-label="Vault shelves grid">
            <!-- JS renders shelves -->
          </div>

          <div class="status muted" style="margin-top:10px;">
            Live valuation recalculates using <span class="mono">/api/spot</span>. Items persist in DB via <span class="mono">/api/vault_items</span>.
          </div>
        </div>
      </section>
    </div>

  </div>

  <script>
    (function () {
      "use strict";

      // ----------------------------
      // Clerk Auth (frontend)
      // ----------------------------
      const btnSignIn = document.getElementById("btnSignIn");
      const btnSignOut = document.getElementById("btnSignOut");
      const authPill = document.getElementById("authPill");
      const authLabel = document.getElementById("authLabel");

      function getClerkPublishableKey() {
        // OPTION A: hardcode it here:
        // return "pk_live_XXXXXXXXXXXXXXXXXXXXXXXX";

        // OPTION B: store it in localStorage once:
        // localStorage.setItem("clerk_publishable_key","pk_live_...");
        return (localStorage.getItem("clerk_publishable_key") || "").trim();
      }

      async function initClerkIfPossible() {
        const pk = getClerkPublishableKey();
        if (!pk || !window.Clerk) {
          btnSignIn.style.display = "";
          btnSignOut.style.display = "none";
          authPill.style.display = "none";
          return false;
        }

        try {
          await window.Clerk.load({ publishableKey: pk });

          btnSignIn.style.display = window.Clerk.user ? "none" : "";
          btnSignOut.style.display = window.Clerk.user ? "" : "none";

          btnSignIn.onclick = () => window.Clerk.openSignIn({});
          btnSignOut.onclick = async () => {
            try { await window.Clerk.signOut(); } catch {}
            location.reload();
          };

          window.Clerk.addListener(() => {
            btnSignIn.style.display = window.Clerk.user ? "none" : "";
            btnSignOut.style.display = window.Clerk.user ? "" : "none";

            if (window.Clerk.user) {
              const email = (window.Clerk.user.primaryEmailAddress && window.Clerk.user.primaryEmailAddress.emailAddress) || "";
              authLabel.textContent = email ? email : ("User " + String(window.Clerk.user.id || "").slice(0, 8));
              authPill.style.display = "";
            } else {
              authPill.style.display = "none";
            }
          });

          if (window.Clerk.user) {
            const email = (window.Clerk.user.primaryEmailAddress && window.Clerk.user.primaryEmailAddress.emailAddress) || "";
            authLabel.textContent = email ? email : ("User " + String(window.Clerk.user.id || "").slice(0, 8));
            authPill.style.display = "";
          } else {
            authPill.style.display = "none";
          }

          return true;
        } catch (e) {
          console.warn("[vault] Clerk init failed:", e);
          btnSignIn.style.display = "";
          btnSignOut.style.display = "none";
          authPill.style.display = "none";
          return false;
        }
      }

      async function getBearerToken() {
        try {
          if (!window.Clerk) return null;
          if (!window.Clerk.session) return null;
          const tok = await window.Clerk.session.getToken();
          return tok || null;
        } catch {
          return null;
        }
      }

      // ----------------------------
      // Core app
      // ----------------------------
      const OZ_TROY_IN_G = 31.1034768;
      const el = (id) => document.getElementById(id);

      const pillGold = el("pillGold");
      const pillSilver = el("pillSilver");
      const pillPlatinum = el("pillPlatinum");

      const spotGoldPill = el("spotGoldPill");
      const spotSilverPill = el("spotSilverPill");
      const spotPlatinumPill = el("spotPlatinumPill");

      const chipUpdated = el("chipUpdated");
      const tierPill = el("tierPill");
      const vaultUpdatedSmall = el("vaultUpdatedSmall");

      const btnRefresh = el("btnRefresh");
      const btnReset = el("btnReset");
      const btnAdd = el("btnAdd");

      const labelInput = el("label");
      const metalSelect = el("metal");
      const itemTypeSelect = el("itemType");
      const weightValueInput = el("weightValue");
      const weightUnitSelect = el("weightUnit");
      const purityPresetSelect = el("purityPreset");
      const purityInput = el("purity");
      const premiumPctInput = el("premiumPct");
      const notesInput = el("notes");

      const statusText = el("statusText");

      const kpiTotal = el("kpiTotal");
      const totalValueEl = el("totalValue");
      const summaryLineEl = el("summaryLine");
      const deltaLineEl = el("deltaLine");

      const kPureAll = el("kPureAll");
      const kPureSub = el("kPureSub");
      const kBreakdown = el("kBreakdown");

      const shelvesGrid = el("shelvesGrid");

      function num(v) {
        if (typeof v === "number") return Number.isFinite(v) ? v : NaN;
        if (v == null) return NaN;
        const s = String(v).trim().replace(/,/g, "");
        const n = parseFloat(s);
        return Number.isFinite(n) ? n : NaN;
      }

      const money = (v) => {
        const n = num(v);
        if (!Number.isFinite(n)) return "$—";
        return n.toLocaleString(undefined, { style: "currency", currency: "USD", minimumFractionDigits: 2, maximumFractionDigits: 2 });
      };
      const fmt4 = (v) => Number.isFinite(num(v)) ? num(v).toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 4 }) : "—";

      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

      function escapeHtml(s) {
        return String(s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function setStatus(msg, kind) {
        statusText.textContent = msg;
        statusText.classList.remove("bad", "good", "warn");
        if (kind) statusText.classList.add(kind);
      }

      function getTier() {
        return (localStorage.getItem("mm_tier") || "free").toLowerCase();
      }

      function highlightActiveMetalPill(metal) {
        pillGold.classList.toggle("isActive", metal === "gold");
        pillSilver.classList.toggle("isActive", metal === "silver");
        pillPlatinum.classList.toggle("isActive", metal === "platinum");
      }

      function formatUpdated(v) {
        if (!v) return null;
        const s = String(v);
        const d = new Date(s);
        if (!isNaN(d.getTime())) {
          return d.toLocaleString(undefined, { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
        }
        return s;
      }

      function weightToOzTroy(weightValue, unit) {
        const w = num(weightValue);
        if (!Number.isFinite(w) || w <= 0) return null;
        return unit === "oz" ? w : (w / OZ_TROY_IN_G);
      }

      function computeItemValuation(item, spot) {
        const metal = item.metal;
        const spotPerOz = spot?.[metal]?.usd;
        if (!Number.isFinite(num(spotPerOz))) return { melt: null, market: null, pureOz: null };

        const purity = clamp(num(item.purity || 0), 0, 1);
        const ozTroy = weightToOzTroy(item.weight_value, item.weight_unit);
        if (!ozTroy) return { melt: null, market: null, pureOz: null };

        const pureOz = ozTroy * purity;
        const melt = pureOz * num(spotPerOz);

        const premPct = num(item.premium_pct);
        const hasPrem = Number.isFinite(premPct);
        const market = hasPrem ? (melt * (1 + premPct / 100)) : melt;

        return { melt, market, pureOz, premPct: hasPrem ? premPct : null };
      }

      async function fetchAny(path) {
        const url = path + (path.includes("?") ? "&" : "?") + "ts=" + Date.now();
        const res = await fetch(url, { cache: "no-store", headers: { "Accept": "application/json" } });
        const text = await res.text();

        let data;
        try { data = JSON.parse(text); }
        catch (e) {
          const err = new Error(`Non-JSON from ${path}: ${text.slice(0, 160)}`);
          err.status = res.status;
          err.payload = text;
          throw err;
        }

        if (!res.ok) {
          const msg = (data && data.error) ? String(data.error) : `HTTP ${res.status}`;
          const err = new Error(msg);
          err.status = res.status;
          err.payload = data;
          throw err;
        }
        return data;
      }

      // Authenticated fetch for vault endpoints
      async function fetchVault(path, init) {
        const tok = await getBearerToken();
        if (!tok) throw new Error("Please sign in to use Vault.");
        const headers = Object.assign({}, (init && init.headers) ? init.headers : {});
        headers["Authorization"] = "Bearer " + tok;
        headers["Accept"] = headers["Accept"] || "application/json";
        const url = path + (path.includes("?") ? "&" : "?") + "ts=" + Date.now();
        const res = await fetch(url, Object.assign({}, init || {}, { headers, cache: "no-store" }));
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { ok:false, error: text.slice(0,200) }; }
        if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
        return data;
      }

      async function postVault(actionBody) {
        return await fetchVault("/api/vault_items", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(actionBody)
        });
      }

      async function loadVaultItems() {
        const j = await fetchVault("/api/vault_items?limit=500");
        state.items = Array.isArray(j.items) ? j.items : [];
      }

      function pullSpotFromKnownShape(obj) {
        if (!obj || typeof obj !== "object") return { ok: false, err: "Invalid response" };

        const apiErr = (obj.ok === false)
          ? (obj.error ? String(obj.error) : "Spot returned ok:false")
          : null;

        const gold = [obj.gold_usd, obj?.normalized?.gold, obj.gold, obj?.raw?.gold].map(num).find(Number.isFinite);
        const silver = [obj.silver_usd, obj?.normalized?.silver, obj.silver, obj?.raw?.silver].map(num).find(Number.isFinite);

        const platinum = [
          obj.platinum_usd,
          obj?.normalized?.platinum,
          obj.xpt_usd,
          obj.xpt,
          obj.platinum,
          obj?.raw?.platinum
        ].map(num).find(Number.isFinite);

        const updatedRaw =
          obj.fetched_at_utc ||
          obj.updated_at ||
          obj.updatedAt ||
          obj.date_utc ||
          obj.date ||
          null;

        const anyFound = (gold != null) || (silver != null) || (platinum != null);
        if (!anyFound && apiErr) return { ok: false, err: apiErr };

        return {
          ok: true,
          g: Number.isFinite(gold) ? gold : null,
          s: Number.isFinite(silver) ? silver : null,
          p: Number.isFinite(platinum) ? platinum : null,
          updatedRaw,
          apiErr
        };
      }

      function unwrap(v) {
        if (!v) return null;
        if (Array.isArray(v)) return v[v.length - 1] || null;
        if (typeof v === "object") {
          if (Array.isArray(v.rows)) return v.rows[v.rows.length - 1] || null;
          if (Array.isArray(v.data)) return v.data[v.data.length - 1] || null;
          if (Array.isArray(v.results)) return v.results[v.results.length - 1] || null;
          if (v.latest && typeof v.latest === "object") return v.latest;
        }
        return v;
      }

      async function fetchSpots() {
        setStatus("Fetching live spot…", "");

        try {
          const [spotRes, latestRes] = await Promise.allSettled([
            fetchAny("/api/spot"),
            fetchAny("/api/latest")
          ]);

          const spotRaw = (spotRes.status === "fulfilled") ? spotRes.value : null;
          const latestRaw = (latestRes.status === "fulfilled") ? latestRes.value : null;

          const spot = pullSpotFromKnownShape(unwrap(spotRaw));
          const latest = pullSpotFromKnownShape(unwrap(latestRaw));

          if (spot.ok) {
            if (spot.g != null) state.spots.gold = spot.g;
            if (spot.s != null) state.spots.silver = spot.s;
            if (spot.p != null) state.spots.platinum = spot.p;
            if (spot.updatedRaw) state.updatedAt = formatUpdated(spot.updatedRaw);
            if (spot.apiErr) setStatus("Spot warning: " + spot.apiErr, "warn");
          }

          if (latest.ok) {
            if (state.spots.gold == null && latest.g != null) state.spots.gold = latest.g;
            if (state.spots.silver == null && latest.s != null) state.spots.silver = latest.s;
            if (state.spots.platinum == null && latest.p != null) state.spots.platinum = latest.p;
            if (!state.updatedAt && latest.updatedRaw) state.updatedAt = formatUpdated(latest.updatedRaw);
          }

          if (!state.updatedAt) state.updatedAt = new Date().toISOString();
          updateSpotHeaderUI();

          const active = state.spots.gold || state.spots.silver || state.spots.platinum;
          if (Number.isFinite(num(active))) setStatus("Live spot loaded. Ready.", "good");
          else setStatus("Live spot unavailable. Try refresh.", "warn");

          renderAll();
        } catch (e) {
          console.error("[vault] fetchSpots failed:", e);
          updateSpotHeaderUI();
          setStatus("Spot fetch failed: " + (e?.message || String(e)), "bad");
          renderAll();
        }
      }

      function updateSpotHeaderUI() {
        highlightActiveMetalPill(state.activeMetalForPills());

        spotGoldPill.textContent = money(state.spots.gold);
        spotSilverPill.textContent = money(state.spots.silver);
        spotPlatinumPill.textContent = money(state.spots.platinum);

        chipUpdated.textContent = state.updatedAt || "—";
        vaultUpdatedSmall.textContent = state.updatedAt ? ("Updated • " + state.updatedAt) : "Vault tool • live spot";

        tierPill.textContent = getTier();
      }

      function buildSpotNormalized() {
        return {
          gold: { usd: state.spots.gold },
          silver: { usd: state.spots.silver },
          platinum: { usd: state.spots.platinum },
        };
      }

      // ----------------------------
      // Shelves layout persistence (local)
      // ----------------------------
      const LAYOUT_KEY = "mm_vault_shelves_v1";
      const SHELVES = [
        { id: "gold",     label: "Gold Shelf",     sub: "Au items",     metalHint: "gold" },
        { id: "silver",   label: "Silver Shelf",   sub: "Ag items",     metalHint: "silver" },
        { id: "platinum", label: "Platinum Shelf", sub: "Pt items",     metalHint: "platinum" },
      ];

      function safeJsonParse(s) {
        try { return JSON.parse(s); } catch { return null; }
      }

      function loadLayout() {
        const raw = localStorage.getItem(LAYOUT_KEY);
        const obj = safeJsonParse(raw || "");
        const base = { shelves: { gold: [], silver: [], platinum: [] } };
        if (!obj || typeof obj !== "object") return base;
        if (!obj.shelves || typeof obj.shelves !== "object") return base;

        // sanitize arrays
        const out = { shelves: { gold: [], silver: [], platinum: [] } };
        ["gold","silver","platinum"].forEach(k => {
          const a = obj.shelves[k];
          out.shelves[k] = Array.isArray(a) ? a.map(String) : [];
        });
        return out;
      }

      function saveLayout() {
        try { localStorage.setItem(LAYOUT_KEY, JSON.stringify(state.layout)); } catch {}
      }

      function ensureLayoutCoversItems() {
        const ids = state.items.map(it => String(it.id));

        // build set of used ids
        const used = new Set();
        ["gold","silver","platinum"].forEach(sid => {
          state.layout.shelves[sid] = (state.layout.shelves[sid] || []).filter(id => {
            const ok = ids.includes(id) && !used.has(id);
            if (ok) used.add(id);
            return ok;
          });
        });

        // add any missing items to a default shelf based on metal
        for (const it of state.items) {
          const id = String(it.id);
          if (used.has(id)) continue;
          const m = (it.metal || "").toLowerCase();
          const shelfId = (m === "gold" || m === "silver" || m === "platinum") ? m : "gold";
          state.layout.shelves[shelfId].push(id);
          used.add(id);
        }

        saveLayout();
      }

      function getShelfIdForItemId(itemId) {
        const id = String(itemId);
        for (const k of ["gold","silver","platinum"]) {
          if ((state.layout.shelves[k] || []).includes(id)) return k;
        }
        return "gold";
      }

      // HTML5 DnD
      let draggingId = null;

      function onDragStartCard(e) {
        const id = e.currentTarget && e.currentTarget.getAttribute("data-id");
        if (!id) return;
        draggingId = String(id);
        e.dataTransfer.effectAllowed = "move";
        try { e.dataTransfer.setData("text/plain", draggingId); } catch {}
        e.currentTarget.classList.add("isDragging");
      }
      function onDragEndCard(e) {
        draggingId = null;
        e.currentTarget.classList.remove("isDragging");
        document.querySelectorAll(".dropZone.isOver").forEach(n => n.classList.remove("isOver"));
      }

      function getCardElementsInZone(zone) {
        return Array.from(zone.querySelectorAll(".vaultCard[data-id]"));
      }

      function findDropIndex(zone, clientY) {
        const cards = getCardElementsInZone(zone).filter(c => !c.classList.contains("isDragging"));
        if (!cards.length) return 0;

        for (let i = 0; i < cards.length; i++) {
          const r = cards[i].getBoundingClientRect();
          const mid = r.top + r.height / 2;
          if (clientY < mid) return i;
        }
        return cards.length;
      }

      function moveItemToShelfAtIndex(itemId, toShelf, toIndex) {
        const id = String(itemId);
        const fromShelf = getShelfIdForItemId(id);
        if (!state.layout.shelves[fromShelf]) state.layout.shelves[fromShelf] = [];
        if (!state.layout.shelves[toShelf]) state.layout.shelves[toShelf] = [];

        // remove from all shelves just to be safe
        ["gold","silver","platinum"].forEach(k => {
          state.layout.shelves[k] = (state.layout.shelves[k] || []).filter(x => String(x) !== id);
        });

        const arr = state.layout.shelves[toShelf];
        const idx = Math.max(0, Math.min(arr.length, Number(toIndex) || 0));
        arr.splice(idx, 0, id);

        saveLayout();
      }

      function wireDropZone(zone, shelfId) {
        zone.addEventListener("dragover", (e) => {
          e.preventDefault();
          zone.classList.add("isOver");
          e.dataTransfer.dropEffect = "move";
        });
        zone.addEventListener("dragleave", () => zone.classList.remove("isOver"));
        zone.addEventListener("drop", (e) => {
          e.preventDefault();
          zone.classList.remove("isOver");
          const id = draggingId || (function(){ try { return e.dataTransfer.getData("text/plain"); } catch { return ""; } })();
          if (!id) return;

          const idx = findDropIndex(zone, e.clientY);
          moveItemToShelfAtIndex(id, shelfId, idx);
          renderAll();
        });
      }

      // ----------------------------
      // Render
      // ----------------------------
      function renderAll() {
        const spot = buildSpotNormalized();

        let totals = { gold: 0, silver: 0, platinum: 0 };
        let pureOz = { gold: 0, silver: 0, platinum: 0 };
        let totalMarket = 0;

        // precompute valuations by id
        const byId = new Map();
        for (const item of state.items) {
          const v = computeItemValuation(item, spot);
          byId.set(String(item.id), { item, v });

          const m = (item.metal || "").toLowerCase();
          if (Number.isFinite(num(v.market))) {
            totalMarket += num(v.market);
            if (m === "gold" || m === "silver" || m === "platinum") totals[m] += num(v.market);
          }
          if (Number.isFinite(num(v.pureOz)) && (m === "gold" || m === "silver" || m === "platinum")) {
            pureOz[m] += num(v.pureOz);
          }
        }

        totalValueEl.textContent = money(totalMarket);

        const allPure = pureOz.gold + pureOz.silver + pureOz.platinum;
        kPureAll.textContent = fmt4(allPure);
        kPureSub.textContent = `Au ${fmt4(pureOz.gold)} • Ag ${fmt4(pureOz.silver)} • Pt ${fmt4(pureOz.platinum)}`;

        kBreakdown.textContent = `${money(totals.gold)} / ${money(totals.silver)} / ${money(totals.platinum)}`;
        summaryLineEl.textContent = `${state.items.length} item${state.items.length === 1 ? "" : "s"} • drag to organize • updates every 60s`;

        if (state.lastTotal != null && Number.isFinite(num(totalMarket))) {
          const d = num(totalMarket) - num(state.lastTotal);
          const abs = Math.abs(d);
          const cls = abs < 0.01 ? "deltaFlat" : (d > 0 ? "deltaUp" : "deltaDown");
          deltaLineEl.className = cls;
          deltaLineEl.textContent = abs < 0.01 ? "Δ —" : `Δ ${money(d)}`;

          if (abs > 0.01) {
            kpiTotal.classList.remove("pulse");
            void kpiTotal.offsetWidth;
            kpiTotal.classList.add("pulse");
          }
        } else {
          deltaLineEl.className = "deltaFlat";
          deltaLineEl.textContent = "Δ —";
        }

        state.lastTotal = totalMarket;

        const tier = getTier();
        const locked = (tier === "free");
        const kpiLocked = el("kpiLocked");
        if (kpiLocked) kpiLocked.setAttribute("data-locked", locked ? "true" : "false");

        // Shelves UI
        if (!shelvesGrid) return;
        shelvesGrid.innerHTML = "";

        for (const s of SHELVES) {
          const ids = (state.layout.shelves[s.id] || []).map(String).filter(id => byId.has(id));
          let shelfMarket = 0;
          let shelfPure = 0;

          ids.forEach(id => {
            const { item, v } = byId.get(id);
            if (Number.isFinite(num(v.market))) shelfMarket += num(v.market);
            if (Number.isFinite(num(v.pureOz))) shelfPure += num(v.pureOz);
          });

          const headAccent =
            s.id === "gold" ? "rgba(245,200,90,.10)" :
            s.id === "silver" ? "rgba(210,220,232,.08)" :
            "rgba(180,195,255,.10)";

          const shelfEl = document.createElement("div");
          shelfEl.className = "shelf";
          shelfEl.innerHTML = `
            <div class="shelfHead" style="background: linear-gradient(180deg, ${headAccent}, rgba(255,255,255,.02));">
              <div class="shelfTitle">
                <b>${escapeHtml(s.label)}</b>
                <span class="mono">${escapeHtml(s.sub)}</span>
              </div>
              <div class="shelfTotals">
                <div class="t1 mono">${money(shelfMarket)}</div>
                <div class="t2 mono">${fmt4(shelfPure)} oz</div>
              </div>
            </div>
            <div class="shelfBody">
              <div class="dropZone" data-shelf="${escapeHtml(s.id)}" aria-label="Drop zone: ${escapeHtml(s.label)}"></div>
            </div>
          `;
          shelvesGrid.appendChild(shelfEl);

          const zone = shelfEl.querySelector(".dropZone");
          wireDropZone(zone, s.id);

          if (!ids.length) {
            const empty = document.createElement("div");
            empty.className = "emptyShelf";
            empty.textContent = "Drop items here";
            zone.appendChild(empty);
            continue;
          }

          for (const id of ids) {
            const { item, v } = byId.get(id);

            const sub = [
              item.item_type ? String(item.item_type) : "",
              item.notes ? String(item.notes) : ""
            ].filter(Boolean).join(" • ");

            const card = document.createElement("div");
            card.className = "vaultCard";
            card.setAttribute("draggable", "true");
            card.setAttribute("data-id", String(item.id));
            card.innerHTML = `
              <div class="vaultCardTop">
                <div class="vaultCardName">
                  <b>${escapeHtml(item.label || "—")}</b>
                  <span class="mono">${sub ? escapeHtml(sub) : "&nbsp;"}</span>
                </div>
              </div>

              <div class="vaultCardMeta">
                <div class="metaPill">
                  <div class="k">Pure oz</div>
                  <div class="v mono">${fmt4(v.pureOz)}</div>
                </div>
                <div class="metaPill">
                  <div class="k">Market</div>
                  <div class="v mono">${money(v.market)}</div>
                </div>
              </div>

              <div class="vaultCardActions">
                <button class="miniBtn miniBtn--danger" type="button" data-del="${escapeHtml(item.id)}">Delete</button>
              </div>
            `;

            card.addEventListener("dragstart", onDragStartCard);
            card.addEventListener("dragend", onDragEndCard);

            zone.appendChild(card);
          }
        }

        // Wire deletes
        shelvesGrid.querySelectorAll("[data-del]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-del");
            if (!id) return;
            if (!confirm("Delete this item?")) return;
            btn.disabled = true;
            try {
              await postVault({ action: "delete", id });
              // remove from layout locally
              ["gold","silver","platinum"].forEach(k => {
                state.layout.shelves[k] = (state.layout.shelves[k] || []).filter(x => String(x) !== String(id));
              });
              saveLayout();

              await refreshVaultOnly();
              renderAll();
            } catch (e) {
              alert(String(e.message || e));
            } finally {
              btn.disabled = false;
            }
          });
        });
      }

      const state = {
        items: [],
        spots: { gold: null, silver: null, platinum: null },
        updatedAt: null,
        lastTotal: null,
        activeMetalForPills: () => "gold",
        layout: loadLayout(),
      };

      purityPresetSelect.addEventListener("change", () => {
        if (purityPresetSelect.value) purityInput.value = purityPresetSelect.value;
      });

      btnRefresh.addEventListener("click", fetchSpots);

      btnReset.addEventListener("click", () => {
        labelInput.value = "";
        metalSelect.value = "gold";
        itemTypeSelect.value = "bullion";
        weightValueInput.value = "";
        weightUnitSelect.value = "g";
        purityPresetSelect.value = "";
        purityInput.value = "";
        premiumPctInput.value = "";
        notesInput.value = "";
        setStatus("Reset.", "");
      });

      btnAdd.addEventListener("click", async () => {
        const payload = {
          action: "create",
          label: (labelInput.value || "").trim(),
          metal: metalSelect.value,
          item_type: itemTypeSelect.value,
          weight_value: num(weightValueInput.value),
          weight_unit: weightUnitSelect.value,
          purity: num(purityInput.value),
          premium_pct: (premiumPctInput.value || "").trim() === "" ? null : num(premiumPctInput.value),
          notes: (notesInput.value || "").trim(),
          source: "manual"
        };

        if (!payload.label) return setStatus("Add a label (what is this item?).", "bad");
        if (!Number.isFinite(payload.weight_value) || payload.weight_value <= 0) return setStatus("Weight must be a positive number.", "bad");
        if (!Number.isFinite(payload.purity) || payload.purity <= 0 || payload.purity > 1) return setStatus("Purity must be between 0 and 1.", "bad");
        if (payload.premium_pct != null && (!Number.isFinite(payload.premium_pct) || payload.premium_pct < 0 || payload.premium_pct > 500)) {
          return setStatus("Premium % must be a reasonable number (0–500).", "bad");
        }

        btnAdd.disabled = true;
        try {
          const res = await postVault(payload);
          setStatus("Added to vault.", "good");

          labelInput.value = "";
          weightValueInput.value = "";
          notesInput.value = "";

          await refreshVaultOnly();

          // ensure new item appears in layout (default shelf = metal)
          ensureLayoutCoversItems();

          renderAll();
        } catch (e) {
          setStatus("Add failed: " + (e?.message || String(e)), "bad");
        } finally {
          btnAdd.disabled = false;
        }
      });

      async function refreshVaultOnly() {
        try {
          await loadVaultItems();
          ensureLayoutCoversItems();
        } catch (e) {
          setStatus(e?.message ? String(e.message) : "Sign in to load vault items.", "warn");
          state.items = [];
        }
      }

      async function refreshAll() {
        tierPill.textContent = getTier();
        await Promise.allSettled([refreshVaultOnly(), fetchSpots()]);
        updateSpotHeaderUI();
        renderAll();
      }

      async function pollSpotOnly() {
        await fetchSpots();
      }

      (async function init() {
        setStatus("Fetching live spot…", "");

        // Wait for Clerk script to be present
        await new Promise((r) => setTimeout(r, 0));
        await initClerkIfPossible();

        await refreshAll();

        setInterval(() => { pollSpotOnly().catch(() => {}); }, 60_000);
      })();
    })();
  </script>
</body>
</html>
